% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).

%============
% REFERENCES
%============

\addbibresource{references.bib}

% Command alias.
\NewDocumentCommand{\printreferences}{}{%
  \printbibliography%
}

% Bibliography options:
%    - Write first and middle names as initials in the bibliography
%    - Sort references by label (when citing)
%    - Set 2 names as max before invoking "et al." when citing
%    - Print all names in bibliography
\ExecuteBibliographyOptions{%
  firstinits=true,
  sortcites=true,
  maxcitenames=2,
  maxbibnames=100,
  hyperref=true,
  urldate=iso8601,
}

% Set author names (but only authors) in small caps (but only in the
% bibliography, not in the citations)
% http://tex.stackexchange.com/a/29862
% http://tex.stackexchange.com/a/30910
\AtBeginBibliography{%
  \renewcommand*{\mkbibnamelast}[1]{%
    \ifmknamesc{\textsc{#1}}{#1}%
  }%
}
\renewcommand*{\mkbibnameprefix}[1]{%
  \ifboolexpr{test {\ifmknamesc} and test {\ifuseprefix}}{%
    \textsc{#1}%
  }{%
    #1%
  }%
}
\def\ifmknamesc{%
  \ifboolexpr{%
    test {\ifcurrentname{labelname}}
    or test {\ifcurrentname{author}}
    or (test {\ifnameundef{author}} and test {\ifcurrentname{editor}})
  }%
}

% Customize appearance of chapter heading
\newcommand{\refname}{References}
\defbibheading{bibliography}[\refname]{%
  \chapter*{#1}%
  \addcontentsline{toc}{chapter}{\refname}%
  \markboth{#1}{#1}%
}

% Set URLs in smaller font in bibliography
\DeclareFieldFormat{url}{URL:~\small\url{#1}}

% Set ISBN, ISSN, and DOI fields in normal font
\DeclareFieldFormat{isbn}{ISBN:~#1}
\DeclareFieldFormat{issn}{ISSN:~#1}
\DeclareFieldFormat{doi}{DOI:~#1}

% Use "Doctoral thesis" instead of "PhD thesis"
\DefineBibliographyStrings{english}{%
  phdthesis={doctoral thesis},
}

% Prevent pagebreaks within entries
% http://tex.stackexchange.com/a/43275/2634
\patchcmd{\bibsetup}{\interlinepenalty=5000}{\interlinepenalty=10000}{}{}

% Remove terminating period from every bib entry
\renewcommand{\finentrypunct}{}
