% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).

%======
% TEXT
%======

% Builds \labelX, \refX, \RefX, \refXRange, and \RefXRange commands:
%    #1: the identifier (X)
%    #2: Short term to appear in reference (without ending dot)
\NewDocumentCommand{\buildLabelRefCommands}{mom}{%
  \expandafter\newcommand\csname label#1\endcsname[1]{\label{#1:##1}}%
  \expandafter\NewDocumentCommand\csname ref#1\endcsname{sm}{%
    \mbox{%
      \IfBooleanF{##1}{#3.\thinspace}%
      \ref{#1:##2}%
    }%
  }%
  \expandafter\NewDocumentCommand\csname ref#1Range\endcsname{smm}{%
    \mbox{%
      \IfBooleanF{##1}{#3.\thinspace}%
      \ref{#1:##2}--\ref{#1:##3}%
    }%
  }%
  \expandafter\NewDocumentCommand\csname Ref#1\endcsname{sm}{%
    \mbox{%
      \IfBooleanF{##1}{#1~}%
      \ref{#1:##2}%
    }%
  }%
  \expandafter\NewDocumentCommand\csname Ref#1Range\endcsname{smm}{%
    \mbox{%
      \IfBooleanF{##1}{%
        \IfValueTF{#2}{#2}{#1s}~%
      }%
      \ref{#1:##2}--\ref{#1:##3}%
    }%
  }%
}

% Build labeling and reference commands
\buildLabelRefCommands{Appendix}[Appendices]{App}
\buildLabelRefCommands{Chapter}{Chap}
\buildLabelRefCommands{Section}{Sect}
\buildLabelRefCommands{Figure}{Fig}
\buildLabelRefCommands{Table}{Tab}
\buildLabelRefCommands{Equation}{Eq}
\buildLabelRefCommands{Algorithm}{Alg}

% Other text commands
\newcommand{\wrt}{w.r.t.}
\newcommand{\todo}[1]{%
  \par\noindent%
  \textcolor{black!25!red}{\raisebox{1pt}{\rule{4pt}{4pt}}~#1}%
  \par%
}

% Enable bold version of the monotype font
% See http://www.macfreek.nl/memory/LaTeX_Bold_Typewriter_Font
\DeclareFontShape{OT1}{cmtt}{bx}{n}%
  {<5><6><7><8><9><10><10.95><12><14.4><17.28><20.74><24.88>cmttb10}{}

% For highlighting text
% See https://tex.stackexchange.com/a/74469/2634
\newcommand{\hlDiffColor}{black!25}
\newcommand{\hlStrut}{%
  \vrule width 0pt height .9\ht\strutbox depth .9\dp\strutbox\relax%
}
\NewDocumentCommand{\hlDiff}{mo}{%
  \IfValueT{#2}{\hspace{#2}}%
  \begingroup%
  \setlength{\fboxsep}{0pt}%
  \ifmmode%
    \colorbox{\hlDiffColor}{\hlStrut$#1$\/}%
  \else%
    \colorbox{\hlDiffColor}{\hlStrut#1\/}%
  \fi%
  \endgroup%
  \IfValueT{#2}{\hspace{#2}}%
}

\NewDocumentEnvironment{statement}{}{%
  \begin{list}{}{}
    \item\itshape%
}{%
  \end{list}%
}



%=======
% LISTS
%=======

\setlist[itemize]{%
  label=\raisebox{1pt}{\rule{4pt}{4pt}},
}

\newlist{inlinelist}{itemize*}{1}
\setlist[inlinelist]{%
  label={},
  itemjoin={},
}

\newlist{contributions}{enumerate}{2}
\setlist[contributions,1]{%
  label=C\arabic*,
  labelsep=8pt,
}
\setlist[contributions,2]{%
  label=\alph*),
  ref=\alph*,
  topsep=0pt,
}

\NewDocumentCommand{\labelContribution}{m}{%
  \label{cont:#1}%
}
\NewDocumentCommand{\refContribution}{m}{%
  \ref{cont:#1}%
}


\newlist{publications}{enumerate}{1}
\setlist[publications]{%
  label=P\arabic*,
  labelsep=8pt,
}

\NewDocumentCommand{\labelPublication}{m}{%
  \label{pub:#1}%
}
\NewDocumentCommand{\refPublication}{m}{%
  \ref{pub:#1}%
}



%=========
% FIGURES
%=========

\newlength{\betweensubfigures}
\setlength{\betweensubfigures}{\baselineskip}



%========
% TABLES
%========

\newcommand{\tabhead}{\bfseries}



%======
% MATH
%======

% General commands
\newcommand{\overbar}[1]{
  \mkern 1.5mu\overline{\mkern-1.5mu#1\mkern-1.5mu}\mkern 1.5mu
}
\NewDocumentCommand{\mPowerset}{m}{
  2^{#1}
}\newcommand{\mNatNumSet}{\mathbb{N}}
\newcommand{\mPhi}{\varphi}
\newcommand{\mSet}[1]{\left\{ #1 \right\}}
\newcommand{\mSetBuilder}[2]{\mSet{#1 \:|\: #2}}
\newcommand{\mCard}[1]{\left| #1 \right|}
\newcommand{\mEmptySet}{\varnothing}
\newcommand{\mFunFont}[1]{\textit{#1}}
\NewDocumentCommand{\mPair}{smm}{%
  \IfBooleanF{#1}{\left}(%
    #2, #3%
  \IfBooleanF{#1}{\right})%
}
\NewDocumentCommand{\mTuple}{smm}{%
  \IfBooleanF{#1}{\left}\langle%
    #2, #3%
  \IfBooleanF{#1}{\right}\rangle%
}
\newcommand{\mUnDirEdge}[2]{\mPair{#1}{#2}}
\newcommand{\mAnd}{\wedge}
\newcommand{\mOr}{\vee}
\newcommand{\mImp}{\Rightarrow}
\newcommand{\mEq}{\Leftrightarrow}
\newcommand{\mQuantSep}{\quad}
\newcommand{\mFunDecl}[3]{%
  #1 : #2 \rightarrow #3%
}
\newcommand{\mVector}[1]{\mathbf{#1}}

% Constraint model-related commands
\newcommand{\mBrPattern}{g_{\mathrm{br}}}
\newcommand{\mKill}{\times}
\newcommand{\mNull}{\bot}
\newcommand{\mUFGraph}{G}
\newcommand{\mPatternSet}{S}
\newcommand{\mExtPatternSet}{\mPatternSet_\mathrm{ext}}
\newcommand{\mOpSet}{O}
\newcommand{\mOperandSet}{P}
\newcommand{\mForbiddenCombSet}{F}
\newcommand{\mCostMatrix}{C_{\textsc{m}}}
\NewDocumentCommand{\mDataSet}{o}{
  \IfValueTF{#1}{D_{#1}}{D}
}
\newcommand{\mBlockSet}{B}
\newcommand{\mDefEdgeSet}{E}
\NewDocumentCommand{\mMatchSet}{o}{
  \IfValueTF{#1}{M_{#1}}{M}
}
\NewDocumentCommand{\mMatchCompSet}{m}{
  M_{\overbar{#1}}
}
\newcommand{\mLocationSet}{L}
\newcommand{\mFallThroughSet}{J}
\newcommand{\mNullLocation}{l_\mathrm{null}}
\NewDocumentCommand{\mVar}{mo}{
  \mathbf{#1}{\IfValueTF{#2}{[#2]}{}}
}
\newcommand{\mLlvmCost}{C_{\textsc{llvm}}}
\newcommand{\mRelaxedCost}{C_{\textsc{rlx}}}
\DeclareMathOperator{\mCircuit}{\mFunFont{circuit}}
\DeclareMathOperator{\mConsumes}{\mFunFont{consumes}}
\DeclareMathOperator{\mCost}{\mFunFont{cost}}
\DeclareMathOperator{\mCovers}{\mFunFont{covers}}
\DeclareMathOperator{\mDefines}{\mFunFont{defines}}
\DeclareMathOperator{\mDom}{\mFunFont{dom}}
\DeclareMathOperator{\mEmptyBlock}{\mFunFont{empty}}
\DeclareMathOperator{\mEntry}{\mFunFont{entry}}
\DeclareMathOperator{\mFreq}{\mFunFont{freq}}
\DeclareMathOperator{\mIntValues}{\mFunFont{intvalues}}
\DeclareMathOperator{\mOpCost}{\mFunFont{cost}}
\DeclareMathOperator{\mRank}{\mFunFont{rank}}
\DeclareMathOperator{\mSpans}{\mFunFont{spans}}
\DeclareMathOperator{\mStores}{\mFunFont{stores}}
\DeclareMathOperator{\mTable}{\mFunFont{table}}
\DeclareMathOperator{\mUses}{\mFunFont{uses}}
\DeclareMathOperator{\mWeight}{\mFunFont{weight}}



%============
% REFERENCES
%============

\addbibresource{references.bib}

% Command alias.
\NewDocumentCommand{\printreferences}{}{%
  \printbibliography%
}

% Bibliography options:
%    - Write first and middle names as initials in the bibliography
%    - Sort references by label (when citing)
%    - Set 2 names as max before invoking "et al." when citing
%    - Print all names in bibliography
\ExecuteBibliographyOptions{%
  giveninits=true,
  sortcites=true,
  maxcitenames=2,
  maxbibnames=100,
  hyperref=true,
  urldate=iso8601,
}

% Customize appearance of chapter heading
\newcommand{\refname}{References}
\defbibheading{bibliography}[\refname]{%
  \chapter*{#1}%
  \addcontentsline{toc}{chapter}{\refname}%
  \markboth{#1}{#1}%
}

% Set URLs in smaller font in bibliography
\DeclareFieldFormat{url}{URL:~\small\url{#1}}

% Set ISBN, ISSN, and DOI fields in normal font
\DeclareFieldFormat{isbn}{ISBN:~#1}
\DeclareFieldFormat{issn}{ISSN:~#1}
\DeclareFieldFormat{doi}{DOI:~#1}

% Use "Doctoral thesis" instead of "PhD thesis"
\DefineBibliographyStrings{english}{%
  phdthesis={doctoral thesis},
}

% Prevent pagebreaks within entries
% http://tex.stackexchange.com/a/43275/2634
\patchcmd{\bibsetup}{\interlinepenalty=5000}{\interlinepenalty=10000}{}{}

% Remove terminating period from every bib entry
\renewcommand{\finentrypunct}{}

% Modify \fullcite to include all authors.
\let\oldfullcite\fullcite
\renewcommand{\fullcite}[1]{%
  \AtNextCite{\AtEachCitekey{\defcounter{maxnames}{100}}}%
  \oldfullcite{#1}%
}



%============
% GLOSSARIES
%============

% Add "glossary" to table of content
\glstoctrue

% Disable hyperlinks from terms to index
\glsdisablehyper

% Customize glossary style
\newglossarystyle{myglossary}{%
  \setglossarystyle{mcolindex}
  \setlength{\columnsep}{8mm}
  \renewcommand*{\glstreenamefmt}[1]{##1}
  \renewcommand*{\glossentry}[2]{%
     \item\glsentryitem{##1}%
       \glstreenamefmt{\glstarget{##1}{\glsentryfirst{##1}}}%
       \space\hfill\space##2%
  }
  \renewcommand{\subglossentry}[3]{%
    \ifcase##1\relax
      % level 0
      \item
    \or
      % level 1
      \subitem
      \glssubentryitem{##2}%
    \else
      % all other levels
      \subsubitem
    \fi
    \glstreenamefmt{\glstarget{##2}{\glossentryname{##2}}}%
    \space\hfill\space##3%
  }%
}
\setglossarystyle{myglossary}

% Commands for introducing terms and acronyms
\NewDocumentCommand{\newterm}{omO{}}{%
  \IfNoValueTF{#1}{%
    \newglossaryentry{#2}{name={#2}, description=\nopostdesc, #3}%
  }{%
    \newglossaryentry{#1}{name={#2}, description=\nopostdesc, #3}%
  }%
}
\let\oldnewacronym\newacronym
\RenewDocumentCommand{\newacronym}{mmO{}}{%
  \oldnewacronym[sort={#2},#3]{#1}{#1}{#2}%
}

% Commands for referring to a short version of a term or acronym
\let\glsshort\glsuseri
\let\Glsshort\Glsuseri
\let\glsplshort\glsuserii
\let\Glsplshort\Glsuserii
\let\glshyphened\glsuseriii
\let\Glshyphened\Glsuseriii

% Adds a modifier to all \gls-like commands for emphasizing the term or acronym
\newcommand{\glsEmph}[1]{\emph{#1}}
\GlsXtrSetAltModifier{!}{format=hyperit}
\makeatletter
\renewcommand*{\glslinkpostsetkeys}{%
  \ifdefstring\@glsnumberformat{hyperit}%
                               {%
                                 \glsreset{\glslabel}%
                                 \let\glstextformat\glsEmph%
                               }%
                               {\let\glstextformat\@firstofone}%
}
\makeatother

% Force 'see also' to appear on a new line in the index
\renewcommand\glsseeformat[3][\seename]{%
  \\*\raggedleft\emph{#1} \glsseelist{#2}%
}

% Rename certain items
\renewcommand{\seename}{see also}
\renewcommand{\glossaryname}{Index}

% Restore long expansion of acronyms on first use
\setabbreviationstyle[acronym]{long-short}



%===================
% TABLE OF CONTENTS
%===================

% Change ToC title
\renewcommand{\contentsname}{Table of Contents}

% Increase width for chapter numbers
\addtolength{\cftchapternumwidth}{4pt}
\addtolength{\cftsectionindent}{4pt}
\addtolength{\cftsectionnumwidth}{3pt}

% Right-align chapter numbers
\renewcommand{\cftchapterpresnum}{\hfill}
\renewcommand{\cftchapteraftersnum}{\hspace*{8pt}}

% Reduce space between leading dots
\renewcommand{\cftsectiondotsep}{4}

% Set titles in ragged right mode
\setrmarg{2.55em plus 1fil}

% Force same indentation for entries in List of Algorithms as other List of Fig.
% https://tex.stackexchange.com/a/381303/2634
\makeatletter
\renewcommand*\l@algocf{\l@figure}
\makeatother



%==============================
% CHAPTER AND SECTION HEADINGS
%==============================

\maxsecnumdepth{subsection}

\setlength{\midchapskip}{50pt}
\renewcommand*{\chapterheadstart}{%
  % Remove all space above chapter heading
}
\renewcommand*{\chapnumfont}{%
  \normalfont\fontsize{80}{100}\selectfont%
}
\renewcommand*{\printchaptername}{%
  % Do not print "Chapter"
}
\renewcommand*{\printchapternum}{%
  \flushright\chapnumfont\thechapter%
}
\renewcommand*{\printchaptertitle}[1]{%
  \flushleft\chaptitlefont#1%
}
\renewcommand*{\chaptitlefont}{%
  \sffamily\Huge\bfseries%
}
\setsecheadstyle{\sffamily\Large\bfseries}
\setsubsecheadstyle{\sffamily\large\bfseries}
\setsubsubsecheadstyle{\sffamily\bfseries}
\setparaheadstyle{\sffamily\bfseries}

% Customize typesetting of page headers
\newcommand{\headerpsep}{%
  \hspace{30pt}% 2x \parindent
}
\nouppercaseheads
\makeevenhead{headings}{\thepage\headerpsep\leftmark}{}{}
\makeoddhead{headings}{}{}{\rightmark\headerpsep\thepage}
\pagestyle{headings}

% Remove 'Chapter' from page headers
\makeatletter
\patchcmd{\chaptermark}{\@chapapp\ }{}{}{}
\makeatother

% Remove number dot from page headers
\patchcmd{\chaptermark}{. \ }{ \ }{}{}
\patchcmd{\sectionmark}{. \ }{ \ }{}{}



%=====================
% CODE AND ALGORITHMS
%=====================

\newcommand{\codeFont}{\ttfamily}
\lstset{basicstyle=\codeFont\footnotesize}
\newcommand{\cCode}[1]{\mbox{\texttt{#1}}}
\newcommand{\cVar}[1]{\cCode{#1}}
\newcommand{\irFont}{\ttfamily}
\newcommand{\irCode}[1]{\mbox{\irFont#1}}
\NewDocumentCommand{\irVar}{mo}{%
  \irCode{#1\IfValueTF{#2}{$_{\text{#2}}$}{}}%
}
\NewDocumentCommand{\irTemp}{m}{%
  \irCode{t$_{\text{#1}}$}%
}
\newcommand{\irAssign}[2]{\mbox{#1 $\leftarrow$ #2}}
\newcommand{\irAdd}[2]{\mbox{#1 $+$ #2}}
\newcommand{\irBlock}[1]{\irCode{#1}}
\newcommand{\irBr}[1]{\mbox{{\irFont\bfseries br} \irBlock{#1}}}
\newcommand{\irCondBr}[3]{%
  \mbox{\irFont\bfseries c.br} #1, \irBlock{#2}, \irBlock{#3}%
}
\newcommand{\irEQ}[2]{\mbox{#1 $=$ #2}}
\newcommand{\irNE}[2]{\mbox{#1 $\neq$ #2}}
\newcommand{\irGE}[2]{\mbox{#1 $>$ #2}}
\newcommand{\irLE}[2]{\mbox{#1 $<$ #2}}
\newcommand{\irMul}[2]{\mbox{#1 $\times$ #2}}
\newcommand{\irLoad}[1]{\mbox{{\irFont\bfseries load} #1}}
\newcommand{\irStore}[2]{\mbox{{\irFont\bfseries store} #1, #2}}
\newcommand{\irCall}[1]{\mbox{{\irFont\bfseries call} #1}}
\newcommand{\irRet}[1]{\mbox{{\irFont\bfseries ret} #1}}

% Commands to be used inside TikZ nodes
\NewDocumentCommand{\noWidth}{mO{0pt}}{%
  \raisebox{#2}[\height][0pt]{#1}%
}
\newcommand{\opAssign}{\irCode{\noWidth{$=$}}}
\newcommand{\opBr}{\irCode{br}}
\newcommand{\opCondBr}{\irCode{c.br}}
\newcommand{\opInBr}{\irCode{in.br}}
\NewDocumentCommand{\opRet}{s}{%
  \IfBooleanTF{#1}{%
    \irCode{ret}%
  }{%
    \irCode{r{\kern-.5pt}e{\kern-.7pt}t}%
  }%
}
\newcommand{\opCopy}{\irCode{\noWidth{cp}}}
\newcommand{\opPhi}{\irCode{\noWidth{$\mPhi$}[.5pt]}}
\newcommand{\opMul}{\irCode{\noWidth{$\times$}}}
\newcommand{\opAdd}{\irCode{\noWidth{$+$}}}
\newcommand{\opSub}{\irCode{\noWidth{$-$}[-1pt]}}
\newcommand{\opGT}{\irCode{\noWidth{$>$}}}
\newcommand{\opLT}{\irCode{\noWidth{$<$}}}
\newcommand{\opGE}{\irCode{\noWidth{$\geq$}}}
\newcommand{\opLE}{\irCode{\noWidth{$\leq$}}}
\newcommand{\opLoad}{\irCode{\noWidth{ld}[.5pt]}}
\newcommand{\opStore}{\irCode{\noWidth{st}[.5pt]}}
\NewDocumentCommand{\opVar}{mo}{%
  \irVar{#1\IfValueTF{#2}{$_{\text{#2}}$}{}}%
  \IfValueTF{#2}{\hspace*{-1pt}}{}%
}
\newcommand{\opTemp}[1]{%
  \irTemp{#1}\hspace*{-1pt}%
}
\newcommand{\opBlock}[1]{\irCode{#1}}

% Commands used for assembly instructions
\let\instrFont\irFont
\let\instrCode\irCode
\let\instrBlock\irBlock
\let\instrEQ\irEQ
\let\instrNE\irNE
\let\instrGE\irGE
\let\instrLE\irLE
\let\instrTemp\irTemp
\let\instrVar\irVar

% Commands for grammars
\NewDocumentCommand{\mNT}{mO{}}{%
  \mathit{#1}_{#2}%
}

% Commands used for algorithms
\newcommand{\Or}{\textbf{or}\ }
\newcommand{\Assign}{$\leftarrow$\ }

\DontPrintSemicolon
\SetNlSty{tiny}{}{}
\SetAlFnt{\figureFont\small}
\SetAlCapSkip{\abovecaptionskip}
\SetAlCapSty{}

% Customize algorithm typesetting
\newcommand{\algStyle}[1]{\textsf{#1}}
\newcommand{\kwStyle}[1]{\algStyle{\textbf{#1}}}
\newcommand{\commentStyle}[1]{\emph{#1}}
\SetKwSty{kwStyle}
\SetArgSty{algStyle}
\SetFuncArgSty{algStyle}
\patchcmd{\SetProgSty}{ArgSty}{ProgSty}{}{}% There is a bug in \SetProgSty
\SetProgSty{algStyle}
\SetCommentSty{commentStyle}
\SetKwComment{cmt}{\righttriangle\:}{}
\SetKw{Return}{return}

% Command for removing algorithm line number for a single line
\let\oldnl\nl
\newcommand{\nonl}{\renewcommand{\nl}{\let\nl\oldnl}}

% Hook for checking whether the 'vlined' option is used
\newbool{VlinedOptionUsed}
\boolfalse{VlinedOptionUsed}
\apptocmd{\SetAlgoVlined}{\booltrue{VlinedOptionUsed}}{}{}

% Command for declaring a function in an algorithm
\newbool{InsideDeclFunction}
\boolfalse{InsideDeclFunction}
\makeatletter
\newcommand{\DeclFunction}[3]{%
  \ifbool{InsideDeclFunction}{}{\nonl}%
  \KwSty{function} #1\,(#2)\KwSty{:}
  \begingroup%
    \booltrue{InsideDeclFunction}%
    \algocf@block{#3}{}{}
  \endgroup%
  \ifbool{VlinedOptionUsed}{}{%
    \ifbool{InsideDeclFunction}{}{\nonl}%
    \KwSty{end}\;%
  }%
}
\makeatother

% Command for calling a function in an algorithm
\newcommand{\Call}[2]{%
  #1\,(#2)%
}

% Redefined \listofalgorithms for consistent appearance
\makeListOfCommand{\listofalgorithms}{\listalgorithmcfname}{loa}{chapter}



%=========
% CAPTION
%=========

% Add period at end of every caption and subcaption
\captionsetup{textformat=period}

% algorithm2e does not obey the caption settings above and requires a patch
\makeatletter
\patchcmd{\algocf@captiontext}{\endgraf}{\unskip.\endgraf}{}{}
\makeatother

% Fix captions of algorithms so that they use the entire text width
\makeatletter
\pretocmd{\algocf@makecaption}{%
  \addtolength{\hsize}{1.5\algomargin}%
  \setlength{\algomargin}{0pt}%
}{}{}
\makeatother




%======
% MISC
%======

\newcommand{\supportNo}{%
  $\cdot$%
}
\newcommand{\supportYes}{%
  \begin{tikzpicture}
    \draw [line width=1.5pt] (0,0) -- ++(-45:4pt) -- ++(45:7.5pt);
  \end{tikzpicture}%
}
\newcommand{\righttriangle}{%
  \begin{tikzpicture}
    \draw [line width=.65pt] (0,0) -- ++(-90:4pt) -- ++(30:4pt) -- cycle;
  \end{tikzpicture}%
}
