% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).

%======
% TEXT
%======

% Builds \labelX, \refX, \RefX, \refXRange, \RefXRange, \refPageOfX, and
% \RefPageOfX commands:
%    #1: The identifier (X) in singular
%    #2: Plural identifier term
%    #3: Short term to appear in reference (without ending dot)
\NewDocumentCommand{\buildLabelRefCommands}{mom}{%
  \expandafter\newcommand\csname label#1\endcsname[1]{\label{#1:##1}}%
  \expandafter\NewDocumentCommand\csname ref#1\endcsname{sm}{%
    \mbox{%
      \IfBooleanF{##1}{#3.\thinspace}%
      \ref{#1:##2}%
    }%
  }%
  \expandafter\NewDocumentCommand\csname ref#1Range\endcsname{smm}{%
    \mbox{%
      \IfBooleanF{##1}{#3s.\thinspace}%
      \ref{#1:##2}--\ref{#1:##3}%
    }%
  }%
  \expandafter\NewDocumentCommand\csname Ref#1\endcsname{sm}{%
    \mbox{%
      \IfBooleanF{##1}{#1~}%
      \ref{#1:##2}%
    }%
  }%
  \expandafter\NewDocumentCommand\csname Ref#1Range\endcsname{smm}{%
    \mbox{%
      \IfBooleanF{##1}{%
        \IfValueTF{#2}{#2}{#1s}~%
      }%
      \ref{#1:##2}--\ref{#1:##3}%
    }%
  }%
  \expandafter\NewDocumentCommand\csname refPageOf#1\endcsname{sm}{%
    \mbox{%
      \IfBooleanF{##1}{p.\thinspace}%
      \pageref{#1:##2}%
    }%
  }%
  \expandafter\NewDocumentCommand\csname RefPageOf#1\endcsname{sm}{%
    \mbox{%
      \IfBooleanF{##1}{Page~}%
      \pageref{#1:##2}%
    }%
  }%
}

% Build labeling and reference commands
\buildLabelRefCommands{Algorithm}{Alg}
\buildLabelRefCommands{Appendix}[Appendices]{App}
\buildLabelRefCommands{Chapter}{Chap}
\buildLabelRefCommands{Definition}{Def}
\buildLabelRefCommands{Equation}{Eq}
\buildLabelRefCommands{Figure}{Fig}
\buildLabelRefCommands{Section}{Sect}
\buildLabelRefCommands{Table}{Tab}

% Macro for labeling and references pages
\newcommand{\labelPage}[1]{\label{page:#1}}
\newcommand{\refPage}[1]{p.\thinspace\pageref{page:#1}}

% Other text commands
\NewDocumentCommand{\etc}{s}{%
  etc%
  \IfBooleanF{#1}{.\ }%
}
\NewDocumentCommand{\st}{s}{%
  s.t%
  \IfBooleanF{#1}{.\ }%
}
\NewDocumentCommand{\wrt}{s}{%
  w.r.t%
  \IfBooleanF{#1}{.\ }%
}
\newcommand{\todo}[1]{%
  \textcolor{black!25!red}{\textsc{todo}:~#1.}%
}
\newcommand{\toolFont}[1]{\textsc{#1}}

% Enable bold version of the monotype font
% See http://www.macfreek.nl/memory/LaTeX_Bold_Typewriter_Font
\DeclareFontShape{OT1}{cmtt}{bx}{n}%
  {<5><6><7><8><9><10><10.95><12><14.4><17.28><20.74><24.88>cmttb10}{}

% For highlighting text
% See https://tex.stackexchange.com/a/74469/2634
\newcommand{\hlDiffColor}{black!25}
\newcommand{\hlStrut}{%
  \vrule width 0pt height .9\ht\strutbox depth .9\dp\strutbox\relax%
}
\NewDocumentCommand{\hlDiff}{mo}{%
  \IfValueT{#2}{\hspace{#2}}%
  \begingroup%
  \setlength{\fboxsep}{0pt}%
  \ifmmode%
    \colorbox{\hlDiffColor}{\hlStrut$#1$\/}%
  \else%
    \colorbox{\hlDiffColor}{\hlStrut#1\/}%
  \fi%
  \endgroup%
  \IfValueT{#2}{\hspace{#2}}%
}

\NewDocumentEnvironment{statement}{}{%
  \begin{list}{}{}
    \item\itshape%
}{%
  \end{list}%
}


%=======
% LISTS
%=======

\setlist[itemize]{%
  label=\raisebox{1pt}{\rule{4pt}{4pt}},
}

\newlist{inlinelist}{enumerate*}{1}
\setlist[inlinelist]{%
  label={},
  itemjoin={},
}

\newlist{contributions}{enumerate}{2}
\setlist[contributions,1]{%
  label=C\arabic*,
  labelsep=8pt,
}
\setlist[contributions,2]{%
  label=\alph*.,
  ref=\alph*,
  topsep=0pt,
}

\NewDocumentCommand{\labelContribution}{m}{%
  \label{cont:#1}%
}
\NewDocumentCommand{\refContribution}{m}{%
  \ref{cont:#1}%
}

\newlist{publications}{enumerate}{1}
\setlist[publications]{%
  label=P\arabic*,
  labelsep=8pt,
}

\NewDocumentCommand{\labelPublication}{m}{%
  \label{pub:#1}%
}
\NewDocumentCommand{\refPublication}{m}{%
  \ref{pub:#1}%
}

\newlist{requirements}{enumerate}{1}
\setlist[requirements]{%
  label=R\arabic*,
  labelsep=8pt,
}

\NewDocumentCommand{\labelRequirement}{m}{%
  \label{req:#1}%
}
\NewDocumentCommand{\refRequirement}{m}{%
  \ref{req:#1}%
}


%==============
% PUBLICATIONS
%==============

\NewDocumentEnvironment{authorsContribution}{}{%

  \vspace{\itemsep}
  \textit{Contribution}\quad%
}{%
}


%=========
% FIGURES
%=========

\newlength{\betweensubfigures}
\setlength{\betweensubfigures}{\baselineskip}


%========
% TABLES
%========

\newcommand{\tabhead}{\sffamily\bfseries}


%======
% MATH
%======

% Define 'definition' environment
\newtheoremstyle{def}%
                {\topsep}%
                {\topsep}%
                {}%
                {}%
                {\sffamily\relsize{-0.8}\bfseries}%
                {}%
                {1em}%
                {\thmname{#1}\thmnumber{ #2}\thmnote{ -- #3}}
\theoremstyle{def}
\newtheorem{definition}{Definition}[chapter]

% Reduce vertical spacing of displaymath inside a 'definition' environment
\AtBeginEnvironment{definition}{%
  \setlength{\abovedisplayskip}{5pt plus 2pt minus 2pt}%
  \setlength{\belowdisplayskip}{5pt plus 2pt minus 2pt}%
}

% General commands
\newcommand{\overbar}[1]{
  \mkern 1.5mu\overline{\mkern-1.5mu#1\mkern-1.5mu}\mkern 1.5mu
}
\NewDocumentCommand{\mPowerset}{m}{
  2^{#1}
}
\newcommand{\transp}{\mathsf{T}}
\newcommand{\mNatNumSet}{\mathbb{N}}
\newcommand{\mPhi}{\varphi}
\NewDocumentCommand{\mSequence}{sm}{
  \IfBooleanT{#1}{\left}\langle
    #2
  \IfBooleanT{#1}{\right}\rangle
}
\NewDocumentCommand{\mSet}{sm}{
  \IfBooleanT{#1}{\left}\{
    #2
  \IfBooleanT{#1}{\right}\}
}
\def\mSetSep{\mid}%
\NewDocumentCommand{\mSetBuilder}{smm}{
  \IfBooleanTF{#1}{
    \left\{
    \begin{array}{@{}c|c@{}}
      #2 & #3
    \end{array}
    \right\}
  }{
    \mSet{#2 \mSetSep #3}
  }
}
\NewDocumentCommand{\mCard}{sm}{
  \IfBooleanT{#1}{\left}|
    #2
  \IfBooleanT{#1}{\right}|
}
\newcommand{\mEmptySet}{\varnothing}
\newcommand{\mFunFont}[1]{\textit{#1}}
\NewDocumentCommand{\mEdge}{mm}{
  #1 \rightarrow #2
}
\NewDocumentCommand{\mPair}{smm}{
  \IfBooleanT{#1}{\left}(
    #2, #3
  \IfBooleanT{#1}{\right})
}
\NewDocumentCommand{\mTuple}{sm}{
  \IfBooleanT{#1}{\left}\langle
    #2
  \IfBooleanT{#1}{\right}\rangle
}
\newcommand{\mAnd}{\wedge}
\newcommand{\mOr}{\vee}
\newcommand{\mImp}{\Rightarrow}
\newcommand{\mEq}{\Leftrightarrow}
\newcommand{\mQuantSep}{\quad}
\newcommand{\mFunDecl}[3]{
  #1 : #2 \rightarrow #3
}
\newcommand{\mVector}[1]{\vec{#1}}
\newcommand{\mBigO}{O}
\DeclareMathOperator{\mInEdgeNr}{\mFunFont{in}}
\DeclareMathOperator{\mOutEdgeNr}{\mFunFont{out}}
\DeclareMathOperator{\mMax}{\mFunFont{max}}
\DeclareMathOperator{\mMin}{\mFunFont{min}}
\DeclareMathOperator{\mPred}{\mFunFont{pred}}
\DeclareMathOperator{\mRank}{\mFunFont{rank}}
\DeclareMathOperator{\mSucc}{\mFunFont{succ}}
\DeclareMathOperator{\mSource}{\mFunFont{source}}
\DeclareMathOperator{\mTarget}{\mFunFont{target}}


% Constraint model-related commands
\renewcommand{\emptyset}{\varnothing}
\newcommand{\mStronger}{\leq}
\newcommand{\mConstraintFont}[1]{\textrm{\textsc{\MakeLowercase{#1}}}}
\newcommand{\mBrPattern}{g_{\mathrm{br}}}
\newcommand{\mConst}{\rule{3pt}{3pt}}
\newcommand{\mCopy}{\circ}
\newcommand{\mKill}{\times}
\newcommand{\mNull}{\bot}
\newcommand{\mNullCopy}{\rlap{$\mCopy$} \mkern-.125mu \mNull}
\newcommand{\mState}{\square}
\newcommand{\mUFGraph}{G}
\newcommand{\mPatternSet}{S}
\newcommand{\mExtPatternSet}{\mPatternSet_\mathrm{ext}}
\newcommand{\mArgSet}{A}
\NewDocumentCommand{\mOpSet}{o}{
  \IfValueTF{#1}{O_{#1}}{O}
}
\NewDocumentCommand{\mOpCompSet}{m}{
  \mOpSet_{\overbar{#1}}
}
\NewDocumentCommand{\mOperandSet}{o}{
  \IfValueTF{#1}{P_{#1}}{P}
}
\NewDocumentCommand{\mOperandCompSet}{m}{
  \mOperandSet_{\overbar{#1}}
}
\newcommand{\mPhiOperandSet}{\mOperandSet[\mPhi]}
\newcommand{\mPhiOperandCompSet}{\mOperandCompSet{\mPhi}}
\newcommand{\mForbiddenCombSet}{F}
\newcommand{\mCostMatrix}{C_{\textsc{m}}}
\newcommand{\mDomMatrix}{R_{\textsc{m}}}
\NewDocumentCommand{\mDataSet}{o}{
  \IfValueTF{#1}{D_{#1}}{D}
}
\NewDocumentCommand{\mDataCompSet}{m}{
  \mDataSet_{\overbar{#1}}
}
\newcommand{\mConstDataSet}{\mDataSet[\mConst]}
\newcommand{\mConstDataCompSet}{\mDataCompSet{\mConst}}
\newcommand{\mStateDataSet}{\mDataSet[\mState]}
\newcommand{\mStateDataCompSet}{\mDataCompSet{\mState}}
\newcommand{\mBlockSet}{B}
\newcommand{\mFunctionDefEdgeSet}{E}
\newcommand{\mMatchDefEdgeSet}{E_{M}}
\NewDocumentCommand{\mMatchSet}{o}{
  \IfValueTF{#1}{M_{#1}}{M}
}
\NewDocumentCommand{\mMatchCompSet}{m}{
  \mMatchSet_{\overbar{#1}}
}
\newcommand{\mCopyMatchSet}{\mMatchSet[\mCopy]}
\newcommand{\mCopyMatchCompSet}{\mMatchCompSet{\mCopy}}
\newcommand{\mKillMatchSet}{\mMatchSet[\mKill]}
\newcommand{\mKillMatchCompSet}{\mMatchCompSet{\mKill}}
\newcommand{\mNullMatchSet}{\mMatchSet[\!\mNull]}
\newcommand{\mNullCopyMatchSet}{\mMatchSet[\mNullCopy]}
\newcommand{\mPhiMatchSet}{\mMatchSet[\mPhi]}
\newcommand{\mPhiMatchCompSet}{\mMatchCompSet{\mPhi}}
\newcommand{\mLocationSet}{L}
\newcommand{\mFallThroughSet}{J}
\NewDocumentCommand{\mInterchDataSet}{o}{
  \IfValueTF{#1}{I_{#1}}{I}
}
\newcommand{\mIntLocation}{l_\textsc{\textrm{int}}}
\newcommand{\mKilledLocation}{l_\textsc{\textrm{killed}}}
\newcommand{\mMemLocation}{l_\textsc{\textrm{mem}}}
\NewDocumentCommand{\mVar}{mo}{
  \mathbf{#1}{\IfValueTF{#2}{[#2]}{}}
}
\newcommand{\mHeuristicCost}{C_{\textsc{\textrm{heur}}}}
\newcommand{\mRelaxedCost}{C_{\textsc{\textrm{rlx}}}}
\DeclareMathOperator{\mAllDiff}{\mConstraintFont{AllDiff}}
\DeclareMathOperator{\mArgLoc}{\mFunFont{argLoc}}
\DeclareMathOperator{\mBlockOf}{\mFunFont{blockOf}}
\DeclareMathOperator{\mCapUseLocsOf}{\mFunFont{capUseLocsOf}}
\DeclareMathOperator{\mCapDefLocsOf}{\mFunFont{capDefLocsOf}}
\DeclareMathOperator{\mCupUseLocsOf}{\mFunFont{cupUseLocsOf}}
\DeclareMathOperator{\mCupDefLocsOf}{\mFunFont{cupDefLocsOf}}
\DeclareMathOperator{\mCircuit}{\mConstraintFont{Circuit}}
\DeclareMathOperator{\mConsumes}{\mFunFont{consumes}}
\DeclareMathOperator{\mCount}{\mConstraintFont{Count}}
\DeclareMathOperator{\mCost}{\mFunFont{cost}}
\DeclareMathOperator{\mCovers}{\mFunFont{covers}}
\DeclareMathOperator{\mCycle}{\mConstraintFont{Cycle}}
\DeclareMathOperator{\mDataOf}{\mFunFont{dataOf}}
\DeclareMathOperator{\mDefines}{\mFunFont{defines}}
\DeclareMathOperator{\mDisableIncompUsers}{\mFunFont{disableUses}}
\DeclareMathOperator{\mDistinct}{\mConstraintFont{Distinct}}
\DeclareMathOperator{\mDom}{\mFunFont{dom}}
\DeclareMathOperator{\mDomain}{\mFunFont{D}}
\DeclareMathOperator{\mEmits}{\mFunFont{emits}}
\DeclareMathOperator{\mEmptyBlock}{\mFunFont{isEmpty}}
\DeclareMathOperator{\mEntry}{\mFunFont{entry}}
\DeclareMathOperator{\mExtValues}{\mFunFont{extValues}}
\DeclareMathOperator{\mIsExt}{\mFunFont{isExt}}
\DeclareMathOperator{\mFreq}{\mFunFont{freq}}
\DeclareMathOperator{\mGCC}{\mConstraintFont{GCC}}
\DeclareMathOperator{\mIncreasing}{\mConstraintFont{inc}}
\DeclareMathOperator{\mOpCost}{\mFunFont{cost}}
\DeclareMathOperator{\mSpans}{\mFunFont{spans}}
\DeclareMathOperator{\mStates}{\mFunFont{states}}
\DeclareMathOperator{\mStores}{\mFunFont{stores}}
\DeclareMathOperator{\mTable}{\mConstraintFont{Table}}
\DeclareMathOperator{\mUses}{\mFunFont{uses}}
\DeclareMathOperator{\mValuePrec}{\mConstraintFont{ValuePre}}
\DeclareMathOperator{\mValuePrecChain}{\mConstraintFont{VPC}}
\DeclareMathOperator{\mWeight}{\mFunFont{weight}}

% blkarray-related commands
\NewDocumentEnvironment{adjblockarray}{mm}{%
  \begin{lrbox}{\adjblockarraybox}%
    $\begin{blockarray}{#1}
}{%
    \end{blockarray}$%
  \end{lrbox}%
  \raisebox{-#2}[\dimexpr\height-#2][\dimexpr\depth-#2]{%
    \usebox{\adjblockarraybox}%
  }%
}
\newsavebox{\adjblockarraybox}


%============
% REFERENCES
%============

\addbibresource{references.bib}

% Command alias.
\NewDocumentCommand{\printreferences}{}{%
  \printbibliography%
}

% Bibliography options:
%    - Write first and middle names as initials in the bibliography
%    - Sort references by label (when citing)
%    - Set 2 names as max before invoking "et al." when citing
%    - Print all names in bibliography
\ExecuteBibliographyOptions{%
  giveninits=true,
  sortcites=true,
  maxcitenames=2,
  maxbibnames=100,
  hyperref=true,
  urldate=iso8601,
}

% Include prefixes in citations.
% https://tex.stackexchange.com/a/23397/2634
\ExecuteBibliographyOptions{%
  useprefix=false,
}
\makeatletter
\AtBeginDocument{%
  \toggletrue{blx@useprefix}% Use prefixes in running text
  \renewcommand*{\mkbibnameprefix}[1]{\MakeCapital{#1}}}% Capitalize prefixes in
                                                        % running text
\AtBeginBibliography{%
  \renewcommand*{\mkbibnameprefix}[1]{#1}}% Uncapitalize prefixes in
                                          % bibliography
\makeatother

% Customize appearance of chapter heading
\newcommand{\refname}{References}
\defbibheading{bibliography}[\refname]{%
  \chapter*{#1}%
  \addcontentsline{toc}{chapter}{\refname}%
  \markboth{#1}{#1}%
}

% Set URLs in smaller font in bibliography
\DeclareFieldFormat{url}{URL:~\small\url{#1}}

% Set URL field in normal font
\DeclareFieldFormat{url}{\textsc{url}:~#1}

% Use "Doctoral thesis" instead of "PhD thesis"
\DefineBibliographyStrings{english}{%
  phdthesis={doctoral thesis},
  urlseen={accessed},
}

% Prevent pagebreaks within entries
% http://tex.stackexchange.com/a/43275/2634
\patchcmd{\bibsetup}{\interlinepenalty=5000}{\interlinepenalty=10000}{}{}

% Modify \fullcite to include all authors.
\let\oldfullcite\fullcite
\renewcommand{\fullcite}[1]{%
  \AtNextCite{\AtEachCitekey{\defcounter{maxnames}{100}}}%
  \oldfullcite{#1}%
}


%============
% GLOSSARIES
%============

% Add "glossary" to table of content
\glstoctrue

% Disable hyperlinks from terms to index
\glsdisablehyper

% Add new field to glossary entries
\glsaddkey{indextext}%
          {\relax}%
          {\glsentryindextext}%
          {\Glsentryindextext}%
          {\glsindextext}%
          {\Glsindextext}%
          {\GLSindextext}

% Customize glossary style
\newglossarystyle{myglossary}{%
  \setglossarystyle{mcolindex}
  \setlength{\columnsep}{8mm}
  \renewcommand*{\glstreenamefmt}[1]{##1}
  \renewcommand*{\glossentry}[2]{%
     \item\glsentryitem{##1}%
       \glstreenamefmt{%
         \glstarget{##1}{%
           \glsletentryfield{\tmp}{##1}{indextext}%
           \if\tmp\relax%
             \glsentryfirst{##1}%
           \else%
             \glsentryindextext{##1}%
           \fi%
         }%
       }%
       \space\hfill\space##2%
  }
  \renewcommand{\subglossentry}[3]{%
    \ifcase##1\relax
      % level 0
      \item
    \or
      % level 1
      \subitem
      \glssubentryitem{##2}%
    \else
      % all other levels
      \subsubitem
    \fi
    \glstreenamefmt{\glstarget{##2}{\glossentryname{##2}}}%
    \space\hfill\space##3%
  }%
}
\setglossarystyle{myglossary}

% Commands for introducing terms and acronyms
\NewDocumentCommand{\newterm}{omO{}}{%
  \IfNoValueTF{#1}{%
    \newglossaryentry{#2}{name={#2}, description={#2}, #3}%
  }{%
    \newglossaryentry{#1}{name={#2}, description={#2}, #3}%
  }%
}
\let\oldnewacronym\newacronym
\RenewDocumentCommand{\newacronym}{ommO{}}{%
  \IfNoValueTF{#1}{%
    \oldnewacronym[sort={#2}, indextext={#2}, #4]{#2}{#2}{#3}%
  }{%
    \oldnewacronym[sort={#2}, indextext={#2}, #4]{#1}{#2}{#3}%
  }%
}

% Commands for referring to a short version of a term or acronym
\let\glsshort\glsuseri
\let\Glsshort\Glsuseri
\let\glsplshort\glsuserii
\let\Glsplshort\Glsuserii
\let\glshyphened\glsuseriii
\let\Glshyphened\Glsuseriii

% Adds a modifier to all \gls-like commands for emphasizing the term or acronym
\newcommand{\glsEmph}[1]{\emph{#1}}
\GlsXtrSetAltModifier{!}{format=hyperit}
\makeatletter
\renewcommand*{\glslinkpostsetkeys}{%
  \ifdefstring\@glsnumberformat{hyperit}%
                               {\let\glstextformat\glsEmph}%
                               {\let\glstextformat\@firstofone}%
}
\makeatother

% Force 'see also' to appear on a new line in the index
\renewcommand\glsseeformat[3][\seename]{%
  \\*\raggedleft\emph{#1} \glsseelist{#2}%
}

% Rename certain items
\renewcommand{\seename}{see also}
\renewcommand{\glossaryname}{Index}

% Restore long expansion of acronyms on first use
\setabbreviationstyle[acronym]{short-long}


%===================
% TABLE OF CONTENTS
%===================

% Change ToC title
\renewcommand{\contentsname}{Table of Contents}

% Increase width for chapter numbers
\addtolength{\cftchapternumwidth}{4pt}
\addtolength{\cftsectionindent}{4pt}
\addtolength{\cftsectionnumwidth}{3pt}

% Right-align chapter numbers
\renewcommand{\cftchapterpresnum}{\hfill}
\renewcommand{\cftchapteraftersnum}{\hspace*{8pt}}

% Reduce space between leading dots
\renewcommand{\cftsectiondotsep}{4}

% Set titles in ragged right mode
\setrmarg{2.55em plus 1fil}

% Force same indentation for entries in List of Algorithms as other List of Fig.
% https://tex.stackexchange.com/a/381303/2634
\makeatletter
\renewcommand*\l@algocf{\l@figure}
\makeatother


%======================================
% TITLE, CHAPTER, AND SECTION HEADINGS
%======================================

\makeatletter
\apptocmd{\@titleFont}{\sffamily}{}{}
\apptocmd{\@frontMatterChapFont}{\sffamily}{}{}
\makeatother

\maxsecnumdepth{subsection}

\setlength{\midchapskip}{50pt}
\renewcommand*{\chapterheadstart}{%
  % Remove all space above chapter heading
}
\renewcommand*{\chapnamefont}{%
  \sffamily\large\scshape%
}
\renewcommand*{\chapnumfont}{%
  \normalfont\fontsize{80}{64}\selectfont%
}
\renewcommand*{\printchaptername}{%
  % Do not print 'Chapter' or 'Appendix'
}
\makeatletter
\renewcommand*{\printchapternum}{%
  \flushright%
  \begin{tabular}{@{}c@{}}
    \chapnamefont\MakeLowercase{\@chapapp}\\[.5ex]
    \chapnumfont\thechapter%
  \end{tabular}%
}
\renewcommand*{\printchaptertitle}[1]{%
  \flushleft\chaptitlefont#1%
}
\renewcommand*{\chaptitlefont}{%
  \sffamily\Huge\bfseries%
}
\setsecheadstyle{\sffamily\Large\bfseries}
\setsubsecheadstyle{\sffamily\large\bfseries}
\setsubsubsecheadstyle{\sffamily\bfseries}
\setparaheadstyle{\sffamily\bfseries}

% Customize typesetting of page headers and footers
\newcommand{\hfPageText}[1]{%
  \footnotesize#1%
}
\newcommand{\hfMarkText}[1]{%
  \footnotesize\textosf{\textsc{\MakeLowercase{#1}}}%
}
\nouppercaseheads
\makeevenhead{headings}{\hfPageText{\thepage}}{}{\hfMarkText{\leftmark}}
\makeoddhead{headings}{\hfMarkText{\rightmark}}{}{\hfPageText{\thepage}}
\makeoddfoot{plain}{}{\hfPageText{\thepage}}{}

% Remove chapter section numbers from header marks
\addtopsmarks{headings}{}{
  \createmark{chapter}{left}{shownumber}{}{ \ }
}
\addtopsmarks{headings}{}{
  \createmark{section}{right}{shownumber}{}{ \ }
}

% Activate changes
\pagestyle{headings}


%=====================
% CODE AND ALGORITHMS
%=====================

\newcommand{\codeFont}{\ttfamily}
\lstset{basicstyle=\codeFont\footnotesize}
\newcommand{\cCode}[1]{\mbox{\texttt{#1}}}
\newcommand{\cVar}[1]{\cCode{#1}}
\newcommand{\irFont}{\ttfamily}
\newcommand{\irCode}[1]{\mbox{\irFont#1}}
\NewDocumentCommand{\irVar}{mo}{%
  \irCode{#1\IfValueTF{#2}{$_{\text{#2}}$}{}}%
}
\NewDocumentCommand{\irTemp}{m}{%
  \irCode{t$_{\text{#1}}$}%
}
\newcommand{\irAssign}[2]{\mbox{#1 $\leftarrow$ #2}}
\newcommand{\irAddText}{$+$}
\newcommand{\irAdd}[2]{\mbox{#1 \irAddText{} #2}}
\newcommand{\irBlock}[1]{\irCode{#1}}
\newcommand{\irBrText}{br}
\newcommand{\irBr}[1]{\mbox{{\irFont\bfseries\irBrText} \irBlock{#1}}}
\newcommand{\irCallText}{call}
\newcommand{\irCall}[1]{\mbox{{\irFont\bfseries\irCallText} #1}}
\newcommand{\irCondBrText}{c.br}
\newcommand{\irCondBr}[3]{%
  \mbox{\irFont\bfseries\irCondBrText} #1, \irBlock{#2}, \irBlock{#3}%
}
\newcommand{\irCpText}{cp}
\newcommand{\irEQText}{$=$}
\newcommand{\irEQ}[2]{\mbox{#1 \irEQText{} #2}}
\newcommand{\irNEText}{$\neq$}
\newcommand{\irNE}[2]{\mbox{#1 \irNEText{} #2}}
\newcommand{\irGEText}{$\geq$}
\newcommand{\irGE}[2]{\mbox{#1 \irGEText{} #2}}
\newcommand{\irGTText}{$>$}
\newcommand{\irGT}[2]{\mbox{#1 \irGTText{} #2}}
\newcommand{\irLEText}{$\leq$}
\newcommand{\irLE}[2]{\mbox{#1 \irLEText{} #2}}
\newcommand{\irLTText}{$<$}
\newcommand{\irLT}[2]{\mbox{#1 \irLTText{} #2}}
\newcommand{\irLSHText}{$\ll$}
\newcommand{\irLSH}[2]{\mbox{#1 \irLSHText{} #2}}
\newcommand{\irMulText}{$\times$}
\newcommand{\irMul}[2]{\mbox{#1 \irMulText{} #2}}
\newcommand{\irLoadText}{load}
\newcommand{\irLoad}[1]{\mbox{{\irFont\bfseries\irLoadText} #1}}
\newcommand{\irPhiText}{$\mPhi$}
\newcommand{\irPhi}[1]{\mbox{\irPhiText(#1)}}
\newcommand{\irRetText}{ret}
\newcommand{\irRet}[1]{\mbox{{\irFont\bfseries\irRetText} #1}}
\newcommand{\irStoreText}{store}
\newcommand{\irStore}[2]{\mbox{{\irFont\bfseries\irStoreText} #1, #2}}
\newcommand{\irSubText}{$-$}
\newcommand{\irSub}[2]{\mbox{#1 \irSubText{} #2}}
\newcommand{\irZextText}{zxt}
\newcommand{\irZext}[1]{\mbox{\irZextText{} #1}}

% Commands to be used inside TikZ nodes
\NewDocumentCommand{\noWidth}{mO{0pt}}{%
  \raisebox{#2}[\height][0pt]{#1}%
}
\newcommand{\opAdd}{\irCode{\noWidth{\irAddText}}}
\newcommand{\opBlock}[1]{\irCode{#1}}
\newcommand{\opBr}{\irCode{\irBrText}}
\newcommand{\opCall}[1]{\irCode{\noWidth{#1}}}
\NewDocumentCommand{\opCondBr}{s}{%
  \IfBooleanTF{#1}{%
    \irCode{\irCondBrText}%
  }{%
    \irCode{c{\kern-1pt}.{\kern-1.2pt}b{\kern-.3pt}r}%
  }%
}
\NewDocumentCommand{\opRet}{s}{%
  \IfBooleanTF{#1}{%
    \irCode{\irRetText}%
  }{%
    \irCode{r{\kern-.3pt}e{\kern-.6pt}t}%
  }%
}
\newcommand{\opCopy}{\irCode{\noWidth{\irCpText}}}
\newcommand{\opEQ}{\irCode{\noWidth{\irEQText}}}
\newcommand{\opGT}{\irCode{\noWidth{\irGTText}}}
\newcommand{\opLT}{\irCode{\noWidth{\irLTText}}}
\newcommand{\opGE}{\irCode{\noWidth{\irGEText}}}
\newcommand{\opLE}{\irCode{\noWidth{\irLEText}}}
\newcommand{\opLSH}{\irCode{\noWidth{\irLSHText}}}
\newcommand{\opLoad}{\irCode{\noWidth{ld}}}
\newcommand{\opMul}{\irCode{\noWidth{\irMulText}}}
\newcommand{\opPhi}{\irCode{\noWidth{\irPhiText}[.5pt]}}
\NewDocumentCommand{\opStore}{s}{%
  \IfBooleanTF{#1}{%
    \irCode{st}%
  }{%
    \irCode{s{\kern-.2pt}t}%
  }%
}
\newcommand{\opSub}{\irCode{\noWidth{\irSubText}[-1pt]}}
\newcommand{\opZext}{\irCode{\noWidth{\irZextText}}}
\newcommand{\opTemp}[1]{%
  \irTemp{#1}\hspace*{-1pt}%
}
\NewDocumentCommand{\opVar}{mo}{%
  \irVar{#1\IfValueTF{#2}{$_{\text{#2}}$}{}}%
  \IfValueTF{#2}{\hspace*{-1pt}}{}%
}

% Commands used for assembly instructions
\let\instrFont\irFont
\let\instrCode\irCode
\let\instrBlock\irBlock
\let\instrEQ\irEQ
\let\instrNE\irNE
\let\instrGE\irGE
\let\instrLE\irLE
\let\instrTemp\irTemp
\let\instrVar\irVar

% Commands for grammars
\NewDocumentCommand{\mNT}{mO{}}{%
  \mathit{#1}_{#2}%
}

% Commands used for algorithms
\newcommand{\Or}{\textbf{or}\ }
\newcommand{\Assign}{$\leftarrow$\ }

\DontPrintSemicolon
\SetNlSty{tiny}{}{}
\SetAlFnt{\figureFont\figureFontSize}
\SetAlCapSkip{\abovecaptionskip}
\SetAlCapSty{}

% Customize algorithm typesetting
\newcommand{\algStyle}[1]{\textsf{#1}}
\newcommand{\kwStyle}[1]{\algStyle{\textbf{#1}}}
\newcommand{\commentStyle}[1]{\emph{#1}}
\SetKwSty{kwStyle}
\SetArgSty{algStyle}
\SetFuncArgSty{algStyle}
\patchcmd{\SetProgSty}{ArgSty}{ProgSty}{}{}% There is a bug in \SetProgSty
\SetProgSty{algStyle}
\SetCommentSty{commentStyle}
\SetKwComment{cmt}{\righttriangle\:}{}
\SetKw{Return}{return}

% Command for removing algorithm line number for a single line
\let\oldnl\nl
\newcommand{\nonl}{\renewcommand{\nl}{\let\nl\oldnl}}

% Hook for checking whether the 'vlined' option is used
\newbool{VlinedOptionUsed}
\boolfalse{VlinedOptionUsed}
\apptocmd{\SetAlgoVlined}{\booltrue{VlinedOptionUsed}}{}{}

% Command for declaring a function in an algorithm
\newbool{InsideDeclFunction}
\boolfalse{InsideDeclFunction}
\makeatletter
\newcommand{\DeclFunction}[3]{%
  \ifbool{InsideDeclFunction}{}{\nonl}%
  \KwSty{function} #1\,(#2):
  \begingroup%
    \booltrue{InsideDeclFunction}%
    \algocf@block{#3}{}{}
  \endgroup%
  \ifbool{VlinedOptionUsed}{}{%
    \ifbool{InsideDeclFunction}{}{\nonl}%
    \KwSty{end}\;%
  }%
}
\makeatother

% Command for calling a function in an algorithm
\newcommand{\Call}[2]{%
  #1\,(#2)%
}

% Redefined \listofalgorithms for consistent appearance
\makeListOfCommand{\listofalgorithms}{\listalgorithmcfname}{loa}{chapter}


%=========
% CAPTION
%=========

% Add period at end of every caption and subcaption
\captionsetup{textformat=period}

% algorithm2e does not obey the caption settings above and requires a patch
\makeatletter
\patchcmd{\algocf@captiontext}{\endgraf}{\unskip.\endgraf}{}{}
\makeatother

% Fix captions of algorithms so that they use the entire text width
\makeatletter
\pretocmd{\algocf@makecaption}{%
  \addtolength{\hsize}{1.5\algomargin}%
  \setlength{\algomargin}{0pt}%
}{}{}
\makeatother


%======
% MISC
%======

\newcommand{\supportNo}{%
  $\cdot$%
}
\newcommand{\supportYes}{%
  \begin{tikzpicture}
    \draw [line width=1.5pt] (0,0) -- ++(-45:4pt) -- ++(45:7.5pt);
  \end{tikzpicture}%
}
\newcommand{\righttriangle}{%
  \begin{tikzpicture}
    \draw [line width=.65pt] (0,0) -- ++(-90:4pt) -- ++(30:4pt) -- cycle;
  \end{tikzpicture}%
}

% Length to be used for storing temporary values
\newlength{\tmpLength}
