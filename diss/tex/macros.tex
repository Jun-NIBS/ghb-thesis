% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).

%======
% TEXT
%======

\newcommand{\labelChapter}[1]{\label{chap:#1}}
\NewDocumentCommand{\refChapter}{sm}{%
  \mbox{%
    \IfBooleanF{#1}{Chap.\thinspace}%
    \ref{chap:#2}%
  }%
}
\newcommand{\labelSection}[1]{\label{sec:#1}}
\newcommand{\refSection}[1]{\mbox{Sect.\thinspace\ref{sec:#1}}}
\newcommand{\labelFigure}[1]{\label{fig:#1}}
\newcommand{\refFigure}[1]{\mbox{Fig.\thinspace\ref{fig:#1}}}
\newcommand{\labelTable}[1]{\label{tab:#1}}
\newcommand{\refTable}[1]{\mbox{Tab.\thinspace\ref{tab:#1}}}
\newcommand{\labelEquation}[1]{\label{eq:#1}}
\NewDocumentCommand{\refEquation}{sm}{%
  \IfBooleanTF{#1}{%
    \ref{eq:#2}%
  }{%
    \mbox{Eq.\thinspace\ref{eq:#2}}%
  }%
}
\NewDocumentCommand{\citeEquation}{sm}{%
  \IfBooleanTF{#1}{%
    #2%
  }{%
    \mbox{Eq.\thinspace#2}%
  }%
}
\newcommand{\wrt}{w.r.t.}
\newcommand{\todo}[1]{%
  \par\noindent%
  \textcolor{black!25!red}{\raisebox{1pt}{\rule{4pt}{4pt}}~#1}%
  \par%
}

% Enable bold version of the monotype font
% See http://www.macfreek.nl/memory/LaTeX_Bold_Typewriter_Font
\DeclareFontShape{OT1}{cmtt}{bx}{n}%
  {<5><6><7><8><9><10><10.95><12><14.4><17.28><20.74><24.88>cmttb10}{}

% For highlighting text
% See https://tex.stackexchange.com/a/74469/2634
\newcommand{\hlDiffColor}{black!25}
\newcommand{\hlStrut}{%
  \vrule width 0pt height .9\ht\strutbox depth .9\dp\strutbox\relax%
}
\NewDocumentCommand{\hlDiff}{mo}{%
  \IfValueT{#2}{\hspace{#2}}%
  \begingroup%
  \setlength{\fboxsep}{0pt}%
  \ifmmode%
    \colorbox{\hlDiffColor}{\hlStrut$#1$\/}%
  \else%
    \colorbox{\hlDiffColor}{\hlStrut#1\/}%
  \fi%
  \endgroup%
  \IfValueT{#2}{\hspace{#2}}%
}

\NewDocumentEnvironment{statement}{}{%
  \par%
  \vspace{\baselineskip}%
  \mbox{}\hfill\begin{minipage}{\textwidth-2\parindent}%
    \itshape\raggedright%
}{%
  \end{minipage}
  \par%
  \vspace{\baselineskip}%
}



%=======
% LISTS
%=======

\setlist[itemize]{%
  label=\raisebox{1pt}{\rule{4pt}{4pt}},
}

\newlist{inlinelist}{itemize*}{1}
\setlist[inlinelist]{%
  label={},
  itemjoin={},
}

\newlist{contributions}{enumerate}{2}
\setlist[contributions,1]{%
  label=C\arabic*,
  labelsep=8pt,
}
\setlist[contributions,2]{%
  label=\alph*),
  ref=\alph*,
  topsep=0pt,
}

\NewDocumentCommand{\labelContribution}{m}{%
  \label{cont:#1}%
}
\NewDocumentCommand{\refContribution}{m}{%
  \ref{cont:#1}%
}


\newlist{publications}{enumerate}{1}
\setlist[publications]{%
  label=P\arabic*,
  labelsep=8pt,
}

\NewDocumentCommand{\labelPublication}{m}{%
  \label{pub:#1}%
}
\NewDocumentCommand{\refPublication}{m}{%
  \ref{pub:#1}%
}



%========
% TABLES
%========

\newcommand{\tabhead}{\bfseries}



%======
% MATH
%======

% General commands
\newcommand{\overbar}[1]{
  \mkern 1.5mu\overline{\mkern-1.5mu#1\mkern-1.5mu}\mkern 1.5mu
}
\NewDocumentCommand{\mPowerset}{m}{
  2^{#1}
}\newcommand{\mNatNumSet}{\mathbb{N}}
\newcommand{\mPhi}{\varphi}
\newcommand{\mSet}[1]{\left\{ #1 \right\}}
\newcommand{\mCard}[1]{\left| #1 \right|}
\newcommand{\mEmptySet}{\varnothing}
\newcommand{\mFunFont}[1]{\textit{#1}}
\newcommand{\mTuple}[2]{\left\langle #1, #2 \right\rangle}
\newcommand{\mUnDirEdge}[2]{\mTuple{#1}{#2}}
\newcommand{\mAnd}{\wedge}
\newcommand{\mOr}{\vee}
\newcommand{\mImp}{\Rightarrow}
\newcommand{\mEq}{\Leftrightarrow}
\newcommand{\mQuantSep}{\quad}

% Constraint model-related commands
\newcommand{\mBrPattern}{g_{\mathrm{br}}}
\newcommand{\mKill}{\times}
\newcommand{\mNull}{\bot}
\newcommand{\mUFGraph}{G}
\newcommand{\mPatternSet}{S}
\newcommand{\mExtPatternSet}{\mPatternSet_\mathrm{ext}}
\newcommand{\mOpSet}{O}
\newcommand{\mOperandSet}{P}
\newcommand{\mForbiddenCombSet}{F}
\newcommand{\mCostMatrix}{\mathbf{C}}
\NewDocumentCommand{\mDataSet}{o}{
  \IfValueTF{#1}{D_{#1}}{D}
}
\newcommand{\mBlockSet}{B}
\newcommand{\mDefEdgeSet}{E}
\NewDocumentCommand{\mMatchSet}{o}{
  \IfValueTF{#1}{M_{#1}}{M}
}
\NewDocumentCommand{\mMatchCompSet}{m}{
  M_{\overbar{#1}}
}
\newcommand{\mLocationSet}{L}
\newcommand{\mFallThroughSet}{J}
\newcommand{\mNullLocation}{l_\mathrm{null}}
\NewDocumentCommand{\mVar}{mo}{
  \mathbf{#1}{\IfValueTF{#2}{[#2]}{}}
}
\newcommand{\mLlvmCost}{C_{\mathrm{LLVM}}}
\newcommand{\mRelaxedCost}{C_{\mathrm{relaxed}}}
\DeclareMathOperator{\mCircuit}{\mFunFont{circuit}}
\DeclareMathOperator{\mConsumes}{\mFunFont{consumes}}
\DeclareMathOperator{\mCost}{\mFunFont{cost}}
\DeclareMathOperator{\mCovers}{\mFunFont{covers}}
\DeclareMathOperator{\mDefines}{\mFunFont{defines}}
\DeclareMathOperator{\mDom}{\mFunFont{dom}}
\DeclareMathOperator{\mEmptyBlock}{\mFunFont{empty}}
\DeclareMathOperator{\mEntry}{\mFunFont{entry}}
\DeclareMathOperator{\mFreq}{\mFunFont{freq}}
\DeclareMathOperator{\mIntValues}{\mFunFont{intvalues}}
\DeclareMathOperator{\mOpCost}{\mFunFont{cost}}
\DeclareMathOperator{\mSpans}{\mFunFont{spans}}
\DeclareMathOperator{\mStores}{\mFunFont{stores}}
\DeclareMathOperator{\mTable}{\mFunFont{table}}
\DeclareMathOperator{\mUses}{\mFunFont{uses}}



%============
% REFERENCES
%============

\addbibresource{references.bib}

% Command alias.
\NewDocumentCommand{\printreferences}{}{%
  \printbibliography%
}

% Bibliography options:
%    - Write first and middle names as initials in the bibliography
%    - Sort references by label (when citing)
%    - Set 2 names as max before invoking "et al." when citing
%    - Print all names in bibliography
\ExecuteBibliographyOptions{%
  giveninits=true,
  sortcites=true,
  maxcitenames=2,
  maxbibnames=100,
  hyperref=true,
  urldate=iso8601,
}

% Customize appearance of chapter heading
\newcommand{\refname}{References}
\defbibheading{bibliography}[\refname]{%
  \chapter*{#1}%
  \addcontentsline{toc}{chapter}{\refname}%
  \markboth{#1}{#1}%
}

% Set URLs in smaller font in bibliography
\DeclareFieldFormat{url}{URL:~\small\url{#1}}

% Set ISBN, ISSN, and DOI fields in normal font
\DeclareFieldFormat{isbn}{ISBN:~#1}
\DeclareFieldFormat{issn}{ISSN:~#1}
\DeclareFieldFormat{doi}{DOI:~#1}

% Use "Doctoral thesis" instead of "PhD thesis"
\DefineBibliographyStrings{english}{%
  phdthesis={doctoral thesis},
}

% Prevent pagebreaks within entries
% http://tex.stackexchange.com/a/43275/2634
\patchcmd{\bibsetup}{\interlinepenalty=5000}{\interlinepenalty=10000}{}{}

% Remove terminating period from every bib entry
\renewcommand{\finentrypunct}{}

% Modify \fullcite to include all authors.
\let\oldfullcite\fullcite
\renewcommand{\fullcite}[1]{%
  \AtNextCite{\AtEachCitekey{\defcounter{maxnames}{100}}}%
  \oldfullcite{#1}%
}



%============
% GLOSSARIES
%============

% Add "glossary" to table of content
\glstoctrue

% Disable hyperlinks from terms to index
\glsdisablehyper

% Customize glossary style
\newglossarystyle{myglossary}{%
  \setglossarystyle{mcolindex}
  \setlength{\columnsep}{8mm}
  \renewcommand*{\glstreenamefmt}[1]{##1}
  \renewcommand*{\glsgroupheading}[1]{%
    \textbf{\large\glsgetgrouptitle{##1}}%
    \nopagebreak%
    \par \vskip 3pt plus 1pt minus 1pt \relax%
    \nopagebreak%
  }
  \renewcommand*{\glossentry}[2]{%
     \item\glsentryitem{##1}%
       \glstreenamefmt{\glstarget{##1}{\glsentryfirst{##1}}}%
       \space\hfill\space##2%
  }
  \renewcommand{\subglossentry}[3]{%
    \ifcase##1\relax
      % level 0
      \item
    \or
      % level 1
      \subitem
      \glssubentryitem{##2}%
    \else
      % all other levels
      \subsubitem
    \fi
    \glstreenamefmt{\glstarget{##2}{\glossentryname{##2}}}%
    \space\hfill\space##3%
  }%
}
\setglossarystyle{myglossary}

% Commands for introducing terms and acronyms
\NewDocumentCommand{\newterm}{omO{}}{%
  \IfNoValueTF{#1}{%
    \newglossaryentry{#2}{name={#2}, description=\nopostdesc, #3}%
  }{%
    \newglossaryentry{#1}{name={#2}, description=\nopostdesc, #3}%
  }%
}
\let\oldnewacronym\newacronym
\RenewDocumentCommand{\newacronym}{mmO{}}{%
  \oldnewacronym[sort={#2},#3]{#1}{#1}{#2}%
}

% Commands for referring to a short version of a term or acronym
\let\glsshort\glsuseri
\let\glsplshort\glsuserii

% Adds a modifier to all \gls-like commands for emphasizing the term or acronym
\GlsXtrSetAltModifier{!}{format=hyperit}
\makeatletter
\renewcommand*{\glslinkpostsetkeys}{%
  \ifdefstring\@glsnumberformat{hyperit}%
                               {%
                                 \glsreset{\glslabel}%
                                 \let\glstextformat\emph%
                               }%
                               {\let\glstextformat\@firstofone}%
}
\makeatother

% Force 'see also' to appear on a new line in the index
\renewcommand\glsseeformat[3][\seename]{%
  \\*\mbox{}\hfill\emph{#1} \glsseelist{#2}%
}

% Rename certain items
\renewcommand{\seename}{see also}
\renewcommand{\glossaryname}{Index}

% Restore long expansion of acronyms on first use
\setabbreviationstyle[acronym]{long-short}



%===================
% TABLE OF CONTENTS
%===================

% Change ToC title
\renewcommand{\contentsname}{Table of Contents}

% Increase width for chapter numbers
\addtolength{\cftchapternumwidth}{4pt}
\addtolength{\cftsectionindent}{4pt}
\addtolength{\cftsectionnumwidth}{3pt}

% Right-align chapter numbers
\renewcommand{\cftchapterpresnum}{\hfill}
\renewcommand{\cftchapteraftersnum}{\hspace*{8pt}}

% Reduce space between leading dots
\renewcommand{\cftsectiondotsep}{4}

% Set titles in ragged right mode
\setrmarg{2.55em plus 1fil}



%==================
% CHAPTER HEADINGS
%==================

\setlength{\midchapskip}{50pt}
\renewcommand*{\chapterheadstart}{%
  % Remove all space above chapter heading
}
\renewcommand*{\chapnumfont}{%
  \normalfont\fontsize{80}{100}\selectfont%
}
\renewcommand*{\printchaptername}{%
  % Do not print "Chapter"
}
\renewcommand*{\printchapternum}{%
  \flushright\chapnumfont\thechapter%
}
\renewcommand*{\printchaptertitle}[1]{%
  \flushleft\chaptitlefont#1%
}

% Customize typesetting of page headers
\newcommand{\headerpsep}{%
  \hspace{30pt}% 2x \parindent
}
\nouppercaseheads
\makeevenhead{headings}{\thepage\headerpsep\leftmark}{}{}
\makeoddhead{headings}{}{}{\rightmark\headerpsep\thepage}
\pagestyle{headings}

% Remove 'Chapter' from page headers
\makeatletter
\patchcmd{\chaptermark}{\@chapapp\ }{}{}{}
\makeatother

% Remove number dot from page headers
\patchcmd{\chaptermark}{. \ }{ \ }{}{}
\patchcmd{\sectionmark}{. \ }{ \ }{}{}



%============
% PARAGRAPHS
%============

% Add period after heading in paragraphs
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{%
  \oldparagraph{#1.}%
}



%=========
% CAPTION
%=========

% Add period at end of every caption and subcaption
\captionsetup{textformat=period}



%======
% MISC
%======

\newcommand{\supportNo}{%
  $\cdot$%
}
\newcommand{\supportYes}{%
  \begin{tikzpicture}
    \draw [line width=1.5pt] (0,0) -- ++(-45:4pt) -- ++(45:7.5pt);
  \end{tikzpicture}%
}

\newcommand{\codeFont}{\ttfamily}
\lstset{basicstyle=\codeFont\footnotesize}
\newcommand{\cCode}[1]{\mbox{\texttt{#1}}}
\newcommand{\cVar}[1]{\cCode{#1}}
\newcommand{\irCode}[1]{\mbox{\textsf{#1}}}
\NewDocumentCommand{\irVar}{mo}{%
  \irCode{#1\IfValueTF{#2}{$_{\text{#2}}$}{}}%
}
\NewDocumentCommand{\irTemp}{m}{%
  \irCode{t$_{\text{#1}}$}%
}
