% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).
%
\begingroup%
\figureFont\figureFontSize%
\begin{tikzpicture}[
    remember picture,
    overlay,
  ]

  % On the first compilation run, the subfigures will not have been correctly
  % positioned, thus causing some of the intersections to not intersect. This
  % in turn means that some of the coordinates will not be defined, which in
  % turn causes a compilation error. We work around this problem by providing a
  % bogus definition of these coordiates, which will later be overwritten by the
  % correct intersection coordinates on subsequent compilation runs.
  \coordinate (c1-intersection-1) at (0,0);
  \coordinate (c2-intersection-1) at (0,0);

  \begin{scope}[data flow]
    \draw [rounded corners=16pt]
          (f-2) |- (end-c);

    \path [name path=right-from-head-c]
          (head-c)
          --
          +(0:.5\textwidth);
    \coordinate (left-of-bool) at ([xshift=-\opNodeDist] bool.west);
    \path [name path=diagonal-from-bool]
          (left-of-bool)
          --
          +(135:2cm);
    \draw [name intersections={
             of=right-from-head-c and diagonal-from-bool,
             name=c1-intersection,
           },
           rounded corners=5pt,
          ]
          (bool)
          --
          (left-of-bool)
          --
          (c1-intersection-1)
          --
          (head-c);
  \end{scope}

  \begin{scope}[data flow]
    \coordinate (df-point-from-entry) at
                ($(entry.north east) !.33! (entry.south east)$);
    \draw [rounded corners=8pt]
          (df-point-from-entry) -| (1-phi-f);
    \foreach \n in {n-1, leq-1, sub-1} {
      \coordinate (entry+\n) at (df-point-from-entry -| \n);
    }
    \draw [rounded corners=8pt]
          ([xshift=-.5\opNodeDist] entry+n-1) -| (n-1);
    \draw [rounded corners=16pt]
          ([xshift=-\opNodeDist] entry+leq-1) -| (leq-1);
    \foreach \n in {leq-1, sub-1} {
      \draw [rounded corners=16pt]
            ([xshift=-\opNodeDist] entry+\n) -| (\n);
    }
  \end{scope}

  \begin{scope}[definition edge]
    \coordinate (def-point-from-entry) at
                ($(entry.north east) !.66! (entry.south east)$);

    \path [name path=right-from-entry]
          (def-point-from-entry)
          --
          (def-point-from-entry -| 1-phi-f);
    \path [name path=diagonal-from-n-1]
          (n-1.north west)
          --
          +(135:\opNodeDist);
    \path [name path=diagonal-from-1-phi-f]
          (1-phi-f.north west)
          --
          +(135:\opNodeDist);
    \draw [name intersections={
             of=right-from-entry and diagonal-from-1-phi-f,
             name=c1-intersection,
           },
           rounded corners=3pt,
          ]
          (def-point-from-entry)
          --
          (c1-intersection-1)
          --
          (1-phi-f);
    \draw [name intersections={
             of=right-from-entry and diagonal-from-n-1,
             name=c1-intersection,
           },
          ]
          (c1-intersection-1)
          --
          (n-1);

    \coordinate (def-point-above-head) at
                ([xshift=.5\opNodeDist, yshift=.5\opNodeDist] head.north east);
    \path [name path=right-from-above-head]
          (def-point-above-head)
          --
          (def-point-above-head -| f-2);
    \path [name path=diagonal-from-n-2]
          (n-2.north west)
          --
          +(135:\opNodeDist);
    \path [name path=diagonal-from-f-2]
          (f-2.north west)
          --
          +(135:\opNodeDist);
    \draw [name intersections={
             of=right-from-above-head and diagonal-from-f-2,
             name=c1-intersection,
           },
           rounded corners=3pt,
          ]
          (head.north east)
          --
          (def-point-above-head)
          --
          (c1-intersection-1)
          --
          (f-2);
    \draw [name intersections={
             of=right-from-above-head and diagonal-from-n-2,
             name=c1-intersection,
           },
          ]
          (c1-intersection-1)
          --
          (n-2);

    \coordinate (def-point-below-body) at
                ([xshift=.5\opNodeDist, yshift=-.5\opNodeDist] body.south east);
    \path [name path=right-from-below-body]
          (def-point-below-body)
          --
          (def-point-below-body -| n-3);
    \path [name path=diagonal-from-n-3]
          (n-3.south west)
          --
          +(-135:\opNodeDist);
    \draw [name intersections={
             of=right-from-below-body and diagonal-from-n-3,
             name=c1-intersection,
           },
           rounded corners=3pt,
          ]
          (body.south east)
          --
          (def-point-below-body)
          --
          (c1-intersection-1)
          -- coordinate [pos=0] (def-start-point-for-f-3)
          (n-3);

    \path [name path=diagonal-from-def-start-point-for-f-3]
          (def-start-point-for-f-3)
          --
          +(-45:2\opNodeDist);
    \coordinate (below-n-3) at ([yshift=-\opNodeDist] n-3.south);
    \path [name path=right-from-below-n-3]
          ([xshift=-\opNodeDist] below-n-3)
          --
          +(0:4\opNodeDist);
    \path [name path=diagonal-from-f-3]
          (f-3.south west)
          --
          +(-135:3\opNodeDist);
    \draw [name intersections={
             of=right-from-below-n-3 and diagonal-from-def-start-point-for-f-3,
             name=c1-intersection,
           },
           name intersections={
             of=right-from-below-n-3 and diagonal-from-f-3,
             name=c2-intersection,
           },
           rounded corners=3pt,
          ]
          (def-start-point-for-f-3)
          --
          (c1-intersection-1)
          --
          (c2-intersection-1)
          --
          (f-3);
  \end{scope}
\end{tikzpicture}%
\endgroup%
