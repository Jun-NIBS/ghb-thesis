% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).
%
\begingroup%
\figureFont%
\pgfdeclarelayer{background1}%
\pgfdeclarelayer{background2}%
\pgfdeclarelayer{background3}%
\pgfsetlayers{background3,background2,background1,main}%
\begin{tikzpicture}[%
    data node/.style={%
      op node,
    },
    outer match node/.style={%
      match node,
      draw=none,
      inner sep=0,
    },
    match label/.style={%
      minimum size=0,
      inner sep=0,
      outer sep=1pt,
      node distance=10pt,
      font=\footnotesize,
    },
  ]

  % Graph
  \node [op node] (add1) {\opAdd};
  \node [data node, position=-135 degrees from add1] (i) {\opVar{i}};
  \node [data node, position=- 45 degrees from add1] (c1) {\opVar{1}};
  \node [op node, position=45 degrees from add1] (mul) {\opMul};
  \node [data node, position=-45 degrees from mul] (c4) {\opVar{4}};
  \node [op node, position=45 degrees from mul] (add2) {\opAdd};
  \node [data node, position=-45 degrees from add2] (A) {\opVar{A}};
  \node [op node, above=of add2] (load) {\opLoad};
  \begin{scope}[data flow]
    \draw (i) -- (add1);
    \draw (c1) -- (add1);
    \draw (add1) -- (mul);
    \draw (c4) -- (mul);
    \draw (mul) -- (add2);
    \draw (A) -- (add2);
    \draw (add2) -- (load);
  \end{scope}

  % Matches
  \begin{pgfonlayer}{background1}
    \node [match node, fill=shade2, fit=(add1)] (m1) {};
    \node [match node, fill=shade2, fit=(add2)] (m2) {};
    \node [match node, fill=shade2, fit=(mul)] (m3) {};
    % m4
    \begin{pgfonlayer}{background2}
      \node [outer match node, inner sep=-1pt, fit=(m3)] (m4a) {};
      \node [outer match node, inner sep=-1pt, fit=(m2)] (m4b) {};
      \draw [match line, bend left=45, fill=shade1]
            (m4a.south east)
            to
            (m4a.south west)
            to
            (m4a.north west)
            -- coordinate (m4)
            (m4b.north west)
            to
            (m4b.north east)
            to
            (m4b.south east)
            --
            cycle;
    \end{pgfonlayer}
    \node [match node, fill=shade1, fit=(load)] (m5) {};
    % m6
    \begin{pgfonlayer}{background3}
      \node [outer match node, inner sep=1pt, fit=(m3)] (m6a) {};
      \node [outer match node, inner sep=1pt, fit=(m2)] (m6b) {};
      \node [outer match node, inner sep=-1pt, fit=(m5)] (m6c) {};
    \end{pgfonlayer}
    % The named paths must be declared outside of pgfonlayer, or else they will
    % disappear when the environment ends
    \path [name path=m6a-to-m6b-east]
          (m6a.south east)
          --
          (m6b.south east)
          --
          +(45:5mm);
    \path [name path=m6c-to-m6b-east]
          (m6b.east)
          --
          (m6b.east |- m6b.south);
    \path [name path=m6a-to-m6b-west]
          (m6a.north west)
          --
          (m6b.north west)
          --
          +(45:5mm);
    \path [name path=m6c-to-m6b-west]
          (m6c.west)
          --
          (m6c.west |- m6b.west);
    \begin{pgfonlayer}{background3}
      \draw [match line, bend left=45, fill=shade3,
             name intersections={of=m6a-to-m6b-west and m6c-to-m6b-west,
                                 by=x-west},
             name intersections={of=m6a-to-m6b-east and m6c-to-m6b-east,
                                 by=x-east},
             rounded corners=4pt,
            ]
            (m6a.south east)
            to
            (m6a.south west)
            to
            (m6a.north west)
            --
            (x-west)
            -- coordinate [pos=.75] (m6)
            (m6c.west)
            to
            (m6c.north)
            to
            (m6c.east)
            --
            (x-east)
            --
            cycle;
    \end{pgfonlayer}
  \end{pgfonlayer}

  % Match labels
  \node [match label, left=of m1] (m1l) {$\strut m_1$};
  \node [match label, right=of m2] (m2l) {$\strut m_2$};
  \node [match label, left=of m3] (m3l) {$\strut m_3$};
  \node [match label, position=135 degrees from m4] (m4l) {$m_4$};
  \node [match label, right=of m5] (m5l) {$\strut m_5$};
  \node [match label, left=of m6] (m6l) {$\strut m_6$};
  \foreach \i in {1, ..., 6} {
    \draw [thick] (m\i) -- (m\i l);
  }
\end{tikzpicture}%
\endgroup%
