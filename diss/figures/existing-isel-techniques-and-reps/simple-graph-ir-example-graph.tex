% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).
%
\begingroup%
\figureFont%
\pgfdeclarelayer{background}%
\pgfsetlayers{background,main}%
\begin{tikzpicture}[%
    region node/.style={
      block node,
    },
    control node/.append style={
      circle,
    },
    aux flow/.style={
      data flow,
      dash pattern=on 2.5pt off 2.5pt,
    },
  ]

  % Data flow
  \node [data node] (n-1) {\opVar{n}[1]};
  \node [op node, position=-45 degrees from n-1] (phi-n) {\opPhi};
  \node [data node, below=of phi-n] (n-2) {\opVar{n}[2]};
  \node [op node, below right=1.5\opNodeDist and .25\opNodeDist of n-2]
        (sub) {\opSub};
  \node [data node, position=45 degrees from sub] (1-sub) {\opVar{1}};
  \node [data node, below=of sub] (n-3) {\opVar{n}[3]};
  \node [op node, position=-135 degrees from n-2] (leq) {\opLE};
  \node [data node, position=135 degrees from leq] (leq-1) {\opVar{1}};
  \node [data node, below=of leq] (b) {};

  \node [data node, right=5\opNodeDist of n-1] (1-phi-f) {\opVar{1}};
  \node [op node, position=-45 degrees from 1-phi-f] (phi-f) {\opPhi};
  \node [data node, below=of phi-f] (f-2) {\opVar{f}[2]};
  \node [op node, position=-135 degrees from f-2] (mul) {\opMul};
  \node [data node, below=of mul] (f-3) {\opVar{f}[3]};
  \node [op node, position=-45 degrees from f-2] (ret) {\opRet};


  \begin{scope}[data flow]
    \draw (n-1) -- (phi-n);
    \draw (phi-n) -- (n-2);
    \draw (1-sub) -- (sub);
    \draw (sub) -- (n-3);
    \draw (n-2) -- (leq);
    \draw (leq-1) -- (leq);
    \draw (leq) -- (b);

    \path [name path=below-n-2]
          (n-2)
          --
          +(-90:2\opNodeDist);
    \path [name path=left-of-sub]
          (sub)
          --
          +(135:2\opNodeDist);
    \draw [name intersections={of=below-n-2 and left-of-sub},
           rounded corners=3pt,
          ]
          (n-2)
          --
          (intersection-1)
          --
          (sub);

    \coordinate (2-phi-n) at ([shift=(45:\opNodeDist)] phi-n.45);
    \draw [-, rounded corners=8pt]
          (n-3)
          --
          ++(-90:\opNodeDist)
          [rounded corners=12pt]
          -|
          ($(1-sub) !.5! (mul)$)
          [rounded corners=16pt]
          |- coordinate [pos=1] (tmp)
          ([xshift=.5\opNodeDist] 2-phi-n);
    \draw [rounded corners=4pt]
          (tmp)
          --
          (2-phi-n)
          --
          (phi-n);

    \draw (1-phi-f) -- (phi-f);
    \draw (phi-f) -- (f-2);
    \draw (f-2) -- (ret);
    \draw (f-2) -- (mul);
    \draw (mul) -- (f-3);
    \coordinate (2-phi-f) at ([shift=(45:\opNodeDist)] phi-f.45);

    \path [name path=left-of-mul]
          (mul)
          --
          +(135:3\opNodeDist);
    \path [name path=right-of-n-2]
          (n-2)
          --
          +(0:5\opNodeDist);
    \draw [name intersections={of=left-of-mul and right-of-n-2},
           rounded corners=3pt,
          ]
          (n-2)
          --
          (intersection-1)
          --
          (mul);
    \draw [-, rounded corners=8pt]
          (f-3)
          --
          ++(-90:\opNodeDist)
          [rounded corners=16pt]
          -|
          ([xshift=.75\opNodeDist] ret.east)
          [rounded corners=10pt]
          |- coordinate [pos=1] (tmp)
          ([xshift=.5\opNodeDist] 2-phi-f);
    \draw [rounded corners=4pt]
          (tmp)
          --
          (2-phi-f)
          --
          (phi-f);
  \end{scope}

  % Control flow
  \node [region node, left=5\opNodeDist of phi-n] (head) {\irBlock{head}};
  \node [region node, above=of head] (entry) {\irBlock{entry}};
  \node [control node] (if) at (head |- b)
        {\irCode{\noWidth{i{\kern-.5pt}f}}};
  \node [region node, position=-135 degrees from if] (body) {\irBlock{body}};
  \node [region node, position=-45 degrees from if] (end) {\irBlock{end}};

  \begin{pgfonlayer}{background}
    \begin{scope}[control flow]
      \draw (entry) -- (head);
      \draw (head) -- (if);
      \draw (if) -- (body);
      \draw (if) -- (end);
      \draw [rounded corners=4pt]
            (body.west)
            --
            +(180:.5\opNodeDist)
            [rounded corners=8pt]
            |-
            (head);
    \end{scope}
  \end{pgfonlayer}

  \draw [data flow] (b) -- (if);

  \begin{scope}[aux flow]
    \draw (head) -- (phi-n);

    \coordinate (c-below-phi-n) at ($(phi-n.south) !.5! (n-2.north)$);
    \path [name path=line-below-phi-n]
          ([xshift=-2\opNodeDist] c-below-phi-n)
          --
          ([xshift=2\opNodeDist] c-below-phi-n);
    \coordinate (c-left-of-phi-n) at ([xshift=-1.5\opNodeDist] phi-n.west);
    \path [name path=line-left-of-phi-n]
          (c-left-of-phi-n)
          --
          +(-45:2\opNodeDist);
    \coordinate (c-right-of-phi-n) at ([xshift=1.5\opNodeDist] phi-n.east);
    \path [name path=line-right-of-phi-n]
          ([shift=(45:-2\opNodeDist)] c-right-of-phi-n)
          --
          (c-right-of-phi-n);
    \draw [name intersections={of=line-left-of-phi-n and line-below-phi-n,
                               by=left-intersection},
           name intersections={of=line-right-of-phi-n and line-below-phi-n,
                               by=right-intersection},
           rounded corners=6pt]
          (c-left-of-phi-n)
          --
          (left-intersection)
          --
          (right-intersection)
          --
          (c-right-of-phi-n)
          --
          (phi-f);

    \draw [rounded corners=8pt]
          (end.south)
          --
          +(-90:.5\opNodeDist)
          [rounded corners=16pt]
          -|
          (ret);
  \end{scope}
\end{tikzpicture}%
\endgroup%
