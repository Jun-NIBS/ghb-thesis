% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).
%
\begingroup%
\footnotesize%
\def\nodeDist{16pt}%
\def\jumpOffset{8pt}%
\pgfdeclarelayer{background}%
\pgfsetlayers{background,main}%
\begin{tikzpicture}[
    every node/.style={
      draw,
      fill=white,
      very thick,
      minimum size=0,
      inner xsep=4pt,
      inner ysep=2.5pt,
      node distance=\nodeDist,
      font=\irFont,
    },
    flow/.style={
      ->,
      very thick,
      shorten <=-2pt,
    },
    tf label/.style={
      draw=none,
      fill=none,
      minimum size=0,
      inner xsep=4pt,
      node distance=0,
      font=\sffamily,
      auto,
    },
    block label/.style={
      tf label,
      inner xsep=0,
      inner ysep=1pt,
      font=\irFont\bfseries,
    },
  ]

  \node (b1) {%
               \begin{tabular}{@{}l@{}}
                 i = 0\\
                 \irJump{} \irBlock{b2}
               \end{tabular}%
             };
  \node [below=of b1] (b2)
        {%
          \begin{tabular}{@{}l@{}}
            \irIf{} i \irLE{} N \irJump{} \irBlock{b3}\\
            \irElse{} \irJump{} end
          \end{tabular}%
        };
  \node [below=of b2] (b3)
        {%
          \begin{tabular}{@{}ll@{}}
            \multicolumn{2}{@{}l@{}}{\irTemp{1} \irAssign{} i \irMul{} 4}\\
            \irTemp{2} \irAssign{} A \irAdd{} \irTemp{1}
              & \irTemp{3} \irAssign{} B \irAdd{} \irTemp{1}\\
            a \irAssign{} \irLoad{} \irTemp{2}
              & b \irAssign{} \irLoad{} \irTemp{3}\\
            \multicolumn{2}{@{}l@{}}{%
              c \irAssign{} a \irAdd{} b%
            }\\
            \multicolumn{2}{@{}l@{}}{%
              \irIf{} MAX \irLE{} c \irJump{} \irBlock{b4}%
            }\\
            \multicolumn{2}{@{}l@{}}{\irElse{} \irJump{} \irBlock{b5}}
          \end{tabular}%
        };
  \node [below right=\nodeDist and 0 of b3.south west] (b4)
        {%
          \begin{tabular}{@{}l@{}}
            c \irAssign{} MAX\\
            \irJump{} \irBlock{b5}
          \end{tabular}%
        };
  \coordinate (from-b4) at ([yshift=\jumpOffset] b4.south east);
  \node [below left=-\jumpOffset and 0 of b3.south east |- from-b4] (b5)
        {%
          \begin{tabular}{@{}l@{}}
            \irTemp{4} \irAssign{} C + \irTemp{1}\\
            \irStore{} \irTemp{4}, c\\
            i \irAssign{} i \irAdd{} 1\\
            \irJump{} \irBlock{b2}
          \end{tabular}%
        };

  \begin{pgfonlayer}{background}
    \begin{scope}[flow]
      \draw (b1) -- (b2);
      \draw (b2) -- node [tf label] {T} (b3);
      \draw (b3) -- node [tf label, inner xsep=2pt, pos=0.1] {T} (b4);
      \draw (b3) -- node [tf label, inner xsep=2pt, pos=0.1, swap] {F} (b5);
      \draw (from-b4) -- (from-b4 -| b5.west);
      \draw [rounded corners=10pt]
            ([yshift=\jumpOffset] b5.south west)
            -|
            ([xshift=-10pt] b3.west)
            |-
            ([yshift=-\jumpOffset] b2.north west);
      \draw (b2) -- node [tf label] {F} ([xshift=2*\nodeDist] b2.east);
    \end{scope}
  \end{pgfonlayer}

  \node [block label, left=of b1, inner xsep=2pt] {b1\hspace*{-1pt}};
  \foreach \i in {2, 3, 4} {
    \node [block label, above right=0 and 0 of b\i.north west] {b\i};
  }
  \node [block label, above left=0 and 0 of b5.north east] {b5};
\end{tikzpicture}%
\endgroup%
