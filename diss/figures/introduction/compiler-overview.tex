% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).
%
\begingroup%
\figureFont%
\def\compStageWidth{1.5cm}%
\def\compStageHeight{8mm}%
\def\compStageDist{0.6*\compStageWidth}%
\def\compWrapperInnerSep{0.5*\compStageDist}%
\def\optStageWidth{\compStageWidth}%
\def\optStageHeight{\compStageHeight}%
\def\optStageDist{0.5*\compStageDist}%
\def\optWrapperInnerSep{3mm}%
\def\backStageWidth{\compStageWidth}%
\def\backStageHeight{\compStageHeight}%
\def\backStageDist{0.5*\compStageDist}%
\def\backWrapperInnerSep{3mm}%
\def\wrapperOuterSep{1.75*\compStageHeight}%
\pgfdeclarelayer{background}%
\pgfsetlayers{background,main}%
\begin{tikzpicture}[%
    input/.style={%
      inner sep=0,
      outer sep=2pt,
      node distance=\compStageDist,
      font=\strut,
    },
    output/.style={%
      input,
    },
    box/.style={%
      draw,
    },
    box/.append style={%
      thick,
    },
    compiler stage/.style={%
      box,
      inner sep=0,
      outer sep=0,
      minimum width=\compStageWidth,
      minimum height=\compStageHeight,
      node distance=\compStageDist,
      fill=shade0,
    },
    compiler wrapper/.style={%
      box,
      inner sep=\compWrapperInnerSep,
      rounded corners=6pt,
      fill=shade2,
    },
    backend stage/.style={%
      compiler stage,
      minimum width=\backStageWidth,
      minimum height=\backStageHeight,
      node distance=\backStageDist,
    },
    backend wrapper/.style={%
      box,
      inner sep=\backWrapperInnerSep,
      rounded corners=3pt,
      fill=shade1,
    },
    optimizer stage/.style={%
      backend stage,
      minimum width=\optStageWidth,
      minimum height=\optStageHeight,
      node distance=\optStageDist,
    },
    optimizer intermediate stage/.style={%
      optimizer stage,
      minimum width=0,
      outer xsep=3pt,
      draw=none,
      fill=none,
    },
    optimizer wrapper/.style={%
      backend wrapper,
      inner xsep=\optWrapperInnerSep,
      inner ysep=\optWrapperInnerSep,
    },
    flow/.style={%
      ->,
      thick,
    },
    label/.style={%
      inner sep=0,
      outer sep=3pt,
      node distance=0,
    },
    wrapper label/.style={%
      label,
      outer sep=0,
      font=\strut\bfseries,
    },
  ]

  \small

  % Compiler stages
  \node [input] (input) {program};
  \node [compiler stage, right=of input] (frontend) {frontend};
  \node [compiler stage, right=of frontend] (optimizer) {optimizer};
  \node [compiler stage, right=of optimizer] (backend) {backend};
  \node [output, right=of backend] (output) {assembly code};
  \begin{pgfonlayer}{background}
    \node [compiler wrapper, fit=(frontend) (optimizer) (backend)]
          (compiler-wrapper) {};
  \end{pgfonlayer}
  \node [wrapper label, above=of compiler-wrapper] {compiler};

  % Compiler execution flow
  \begin{scope}[flow]
    \draw (input) -- (frontend);
    \draw (frontend) -- node [label, above] {IR} (optimizer);
    \draw (optimizer) -- node [label, above] {IR} (backend);
    \draw (backend) -- (output);
  \end{scope}

  \footnotesize

  % Optimizer stages
  \node [optimizer stage, below=\wrapperOuterSep of optimizer] (gcmotion) {%
    \begin{tabular}{c}
      global\\
      code motion
    \end{tabular}
  };
  \node [optimizer intermediate stage, left=of gcmotion] (pre-gcmotion)
        {$\ldots$};
  \node [optimizer intermediate stage, right=of gcmotion] (post-gcmotion)
        {$\ldots$};
  \begin{pgfonlayer}{background}
    \node [optimizer wrapper, fit=(pre-gcmotion) (gcmotion) (post-gcmotion)]
          (optimizer-wrapper) {};
  \end{pgfonlayer}
  \node [wrapper label, above=of optimizer-wrapper] {optimizer};

  % Optimizer execution flow
  \begin{scope}[flow]
    \draw ([xshift=-\optStageDist] optimizer-wrapper.west)
          --
          (pre-gcmotion);
    \draw (pre-gcmotion) -- (gcmotion);
    \draw (gcmotion) -- (post-gcmotion);
    \draw (post-gcmotion)
          --
          ([xshift=\optStageDist] optimizer-wrapper.east);
  \end{scope}

  % Backend stages
  \node [backend stage, below left=\wrapperOuterSep and 36pt of gcmotion]
        (isel)
  {%
    \begin{tabular}{c}
      instruction\\
      selection
    \end{tabular}
  };
  \node [backend stage, right=of isel] (regalloc) {%
    \begin{tabular}{c}
      register\\
      allocation
    \end{tabular}
  };
  \node [backend stage, right=of regalloc] (isched) {%
    \begin{tabular}{c}
      instruction\\
      scheduling
    \end{tabular}
  };
  \node [backend stage, right=of isched] (ordering) {%
    \begin{tabular}{c}
      block\\
      ordering
    \end{tabular}
  };
  \begin{pgfonlayer}{background}
    \node [backend wrapper, fit=(isel) (regalloc) (isched) (ordering)]
          (backend-wrapper) {};
  \end{pgfonlayer}

  % Backend execution flow
  \begin{scope}[flow]
    \draw ([xshift=-\backStageDist] backend-wrapper.west) -- (isel);
    \draw (isel) -- (regalloc);
    \draw (regalloc) -- (isched);
    \draw (isched) -- (ordering);
    \draw (ordering) -- ([xshift=\backStageDist] backend-wrapper.east);
  \end{scope}
  \node [wrapper label, above=of backend-wrapper] {backend};
\end{tikzpicture}%
\endgroup%
