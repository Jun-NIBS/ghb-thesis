% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).
%
\begingroup%
\figureFont%
\def\compStageWidth{1.5cm}%
\def\compStageHeight{8mm}%
\def\compStageDist{0.6*\compStageWidth}%
\def\compWrapperInnerSep{0.5*\compStageDist}%
\def\backStageWidth{\compStageWidth}%
\def\backStageHeight{\compStageHeight}%
\def\backStageDist{0.5*\compStageDist}%
\def\backWrapperInnerSep{3mm}%
\def\wrapperOuterSep{9mm}%
\pgfdeclarelayer{background}%
\pgfsetlayers{background,main}%
\begin{tikzpicture}[%
    box/.style={%
      draw,
    },
    box/.append style={%
      thick,
    },
    compiler stage/.style={%
      box,
      inner sep=0,
      outer sep=0,
      minimum width=\compStageWidth,
      minimum height=\compStageHeight,
      node distance=\compStageDist,
      fill=shade0,
    },
    compiler wrapper/.style={%
      box,
      inner sep=\compWrapperInnerSep,
      rounded corners=6pt,
      fill=shade2,
    },
    compiler input/.style={%
      inner sep=0,
      outer sep=2pt,
      node distance=\compStageDist,
      font=\strut,
    },
    compiler output/.style={%
      compiler input,
    },
    backend stage/.style={%
      compiler stage,
      minimum width=\backStageWidth,
      minimum height=\backStageHeight,
      node distance=\backStageDist,
    },
    backend wrapper/.style={%
      box,
      inner sep=\backWrapperInnerSep,
      rounded corners=3pt,
      fill=shade1,
    },
    backend input/.style={%
      compiler input,
      node distance=\backStageDist,
      font=\rule[-.25\baselineskip]{0pt}{\baselineskip},
    },
    backend output/.style={%
      backend input,
    },
    flow/.style={%
      ->,
      thick,
    },
    label/.style={%
      inner sep=0,
      outer sep=3pt,
      node distance=0,
    },
    wrapper label/.style={%
      label,
      outer sep=0,
      font=\strut\bfseries,
    },
  ]

  \small

  % Compiler stages
  \node [compiler input] (compiler-input) {program};
  \node [compiler stage, right=of compiler-input] (frontend) {frontend};
  \node [compiler stage, right=of frontend] (optimizer) {optimizer};
  \node [compiler stage, right=of optimizer] (backend) {backend};
  \node [compiler output, right=of backend] (compiler-output) {assembly code};
  \begin{pgfonlayer}{background}
    \node [compiler wrapper, fit=(frontend) (optimizer) (backend)]
          (compiler-wrapper) {};
  \end{pgfonlayer}
  \node [wrapper label, above=of compiler-wrapper] {compiler};

  % Compiler execution flow
  \begin{scope}[flow]
    \draw (compiler-input) -- (frontend);
    \draw (frontend) -- node [label, above] {IR} (optimizer);
    \draw (optimizer) -- node [label, above] {IR} (backend);
    \draw (backend) -- (compiler-output);
  \end{scope}

  \footnotesize

  % Backend stages
  \node [backend stage,
         below right=\wrapperOuterSep and 20pt of compiler-wrapper.south west]
        (isel)
  {%
    \begin{tabular}{c}
      instruction\\
      selection
    \end{tabular}
  };
  \node [backend stage, right=of isel] (regalloc) {%
    \begin{tabular}{c}
      register\\
      allocation
    \end{tabular}
  };
  \node [backend stage, right=of regalloc] (isched) {%
    \begin{tabular}{c}
      instruction\\
      scheduling
    \end{tabular}
  };
  \begin{pgfonlayer}{background}
    \node [backend wrapper, fit=(isel) (regalloc) (isched)]
          (backend-wrapper) {};
  \end{pgfonlayer}
  \node [backend input, left=of backend-wrapper.west] (back-input) {IR};
  \node [backend output, right=of backend-wrapper.east] (back-output)
        {assembly code};
  \node [wrapper label, above=of backend-wrapper] {backend};

  % Backend execution flow
  \begin{scope}[flow]
    \draw ([xshift=-\backStageDist] backend-wrapper.west) -- (isel);
    \draw (isel) -- (regalloc);
    \draw (regalloc) -- (isched);
    \draw (isched) -- ([xshift=\backStageDist] backend-wrapper.east);
  \end{scope}
\end{tikzpicture}%
\endgroup%
