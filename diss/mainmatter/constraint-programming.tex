% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).

\chapter{Constraint Programming}
\labelChapter{constraint-programming}

This chapter describes \glsdesc{CP}, which is the method used in this
dissertation for modeling and solving the problems described in
\refChapter{introduction}.
%
\refSection{cp-overview} gives a brief overview (for a comprehensive overview of
\gls{CP}, see \cite{RossiEtAl:2006}).
%
\refSection{cp-modeling} describes how to describe problems as a \gls{constraint
  model}, and \refSection{cp-solving} describes the techniques applied in
solving these \glsplshort{constraint model}.



\section{Overview}
\labelSection{cp-overview}

As already mentioned, \glsdesc{CP} is a method for solving computationally hard
problems.
%
These problems are typically optimization problems, but the method can also be
applied to solve satisfaction problems.
%
In terms of modeling, \gls{CP} offers a higher level of abstraction than similar
methods such as \gls{IP} and \gls{SAT}~\cite{BiereEtAl:2009}.
%
For example, \gls{CP} provides dedicated constraints for capturing many
recurring problem structures that must be decomposed and reformulated in
\gls{IP} and \gls{SAT}~models.
%
This also makes \gls{CP} particularly suited for solving problems that appear in
\gls{instruction selection}, \gls{global code motion}, and \gls{block ordering}.



\section{Modeling}
\labelSection{cp-modeling}

To solve a problem using \gls{CP}, it must first be formulated as a
\gls{constraint model}~\cite{Smith:2006}.
%
A \gls!{constraint model} consists of two elements:%
%
\begin{inlinelist}[itemjoin={, }, itemjoin*={, and}]
  \item a set of \glspl{variable}
  \item a set of \glspl{constraint}
\end{inlinelist}.
%
\Glspl!{variable} represent problem decisions and take their values from a
finite \gls{domain}.
%
The \gls!{domain} of a variable~$x$, denoted $\mDomain(\mVar{x})$, is typically
is a set of integers, but it can also consist of real numbers and complex
structures such as string, sets, and \glspl{graph}~\cite{Gervet:2006}.
%
\Glspl!{constraint} express relations between \glspl{variable} and forbid
assignments that are illegal in the problem.
%
Formally, we say that a \gls{constraint}~$C$ applied on a set of
\glspl{variable} returns a subset of the Cartesian product of the
\glspl{variable}' \glspl{domain}, i.e.\ \mbox{$C(\mVar{x}_1, \ldots, \mVar{x}_k)
  \subseteq \mDomain(\mVar{x}_1) \times \ldots \times \mDomain(\mVar{x}_k)$}.
%
A tuple $\mTuple{d_1, \ldots, d_k} \in C(\mVar{x}_1, \ldots, \mVar{x}_k)$ is
called a \gls!{solution}[ to $C$], and an assignment to all \glspl{variable}
that fulfills all \glspl{constraint} in a \gls{constraint model}~$M$ is called a
\gls!{solution}[ to $M$].
%
An example is shown in \refFigure{cp-example}.

\begin{figure}
  \centering%
  \figureFont\figureFontSize%
  \mbox{}%
  \hfill\hfill%
  \subcaptionbox{Constraint model\labelFigure{cp-example-model}}%
                {%
                  \begin{tabular}{lc}
                    \toprule
                    \multicolumn{1}{c}{\tabhead Variables}
                      & \tabhead Constraints\\
                    \midrule
                      $\mVar{x} \in \mSet{1, 2}$ & $\mVar{x} \neq \mVar{y}$\\
                      $\mVar{y} \in \mSet{1, 2}$ & $\mVar{x} \neq \mVar{z}$\\
                      $\mVar{z} \in \mSet{1, 2, 3, 4}$
                        & $\mVar{y} \neq \mVar{z}$\\
                    \bottomrule
                  \end{tabular}%
                }%
  \hfill%
  \subcaptionbox{Solutions\labelFigure{cp-example-solutions}}%
                [21mm]%
                {%
                  $\begin{array}{c@{\:}c@{\:}c@{\:}c@{\:}c}
                       & \mVar{x}\phantom{,}
                       & \mVar{y}\phantom{,}
                       & \mVar{z}
                       & \\
                     \langle & 1, & 2, & 3 & \rangle \\
                     \langle & 2, & 1, & 3 & \rangle \\
                     \langle & 1, & 2, & 4 & \rangle \\
                     \langle & 2, & 1, & 4 & \rangle \\
                   \end{array}$%
                }%
  \hfill\hfill%
  \mbox{}

  \caption[Example of a constraint model]%
          {%
            Example of a constraint model, corresponding to a problem where
            three variables must be assigned values which are different from one
            another%
          }
  \labelFigure{cp-example}
\end{figure}



\subsubsection{Global Constraints}

If a \gls!{binary.c}[ \gls{constraint}] is a \gls{constraint} involving two
\glspl{variable}, then a \gls!{global.c}[ \gls{constraint}] is a
\gls{constraint} involving three or more
\glspl{variable}~\cite{VanHoeveKatriel:2006}.
%
\Gls{global.c} \glspl{constraint} capture recurring problem structures and
improve solving compared to relations modeled using multiple \gls{binary.c}
\glspl{constraint}.

An example of a \gls{global.c} \gls{constraint} is the \gls!{distinct
  constraint}, typically referred to as $\mDistinct$ or $\mAllDiff$, which
enforces all \glspl{variable} in a given set to take distinct values.
%
Formally, the \gls{constraint} is defined as follows.
%
\begin{definition}[\Gls{distinct constraint}]%
  \begin{displaymath}
    \mDistinct(\mVar{x}_1, \ldots, \mVar{x}_k)
    =
    \mSetBuilder{\langle d_1, \ldots, d_k \rangle}%
                {\forall_i \: d_i \in \mDomain(\mVar{x}_i),
                 \forall_{i \neq j} \: d_i \neq d_j}.
  \end{displaymath}%
\end{definition}
%
Hence the \glspl{constraint} in \refFigure{cp-example} can be replaced by
$\mDistinct(\mVar{x}, \mVar{y}, \mVar{z})$.

In \refChapter{existing-isel-techniques-and-reps} we saw another \gls{global.c}
\gls{constraint} -- $\mCount$, defined in \refEquation{count-def} -- and how it
can be used to model the \gls{pattern selection} problem.
%
Another relevant example is the \gls!{circuit constraint}, typically referred to
as $\mCircuit$ or $\mCycle$, which enforces that the \glspl{variable}
representing adjacency forms a cycle.
%
Formally, assuming \mbox{$\mDomain(\mVar{x}_i) \subseteq \mSet{1, \ldots, k}$},
the \gls{constraint} is defined as follows:
%
\begin{definition}[\Gls{circuit constraint}]


  \begin{displaymath}
    \mCircuit(\mVar{x}_1, \ldots, \mVar{x}_k)
    =
    \mSetBuilder{\langle d_1, \ldots, d_k \rangle}%
                {
                  \forall_i \: d_i \in \mDomain(\mVar{x}_i),
                  \text{$d_1, \ldots, d_k$ is cyclic}
                }.
  \end{displaymath}
\end{definition}
%
As will be seen in \refChapter{modeling-block-ordering}, $\mCircuit$ can be used
to model \gls{block ordering}.



\todo{discuss circuit}

\todo{discuss table}



\section{Solving}
\labelSection{cp-solving}

\todo{write}



\subsubsection{Propagation}

\todo{write}



\subsubsection{Search}

\todo{write}



\subsubsection{Implied Constraints and Dominance Breaking}

\todo{write}



\subsubsection{Presolving}

\todo{write}
