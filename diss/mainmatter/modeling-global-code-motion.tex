% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).

\chapter{Modeling Global Code Motion}
\labelChapter{modeling-global-code-motion}

\todo{write summary}



\section{Definitions and Uses of Data}

\Glspl{datum} must be placed in \glspl{block} such that each definition of a
\gls{datum}~$d$ precedes all \gls{use.d}[s] of~$d$.
%
This condition can be expressed in terms of \gls{block} dominance.
%
Given a \gls{function}~$f$, a \gls{block}~$b$ in $f$ \gls!{dominate.b}[s]
another \gls{block}~$c$ in $f$ if $b$ appears on every control-flow path from
$f$'s \gls{entry block} to $c$ (see \refFigure{block-dominance-example} for an
example).
%
\begin{figure}
  \mbox{}%
  \hfill%
  \subcaptionbox{Control-flow graph\labelFigure{block-dominance-example-cfg}}%
                [34mm]%
                {%
                  \input{%
                    figures/modeling-global-code-motion/block-dominance-example%
                  }%
                }%
  \hfill%
  \subcaptionbox{Dominance\labelFigure{block-dominance-example-doms}}%
                {%
                  \figureFontSize%
                  \begin{tabular}{cc}
                    \toprule
                      \tabhead Block
                    & \tabhead dominates\\
                    \midrule
                      \irBlock{entry}
                    & $\mSet{\irBlock{entry}, \irBlock{A}, \irBlock{B},
                        \irBlock{C}, \irBlock{D}, \irBlock{E}}$\\
                      \irBlock{A}
                    & $\mSet{\irBlock{A}, \irBlock{B}, \irBlock{C},
                        \irBlock{D}}$\\
                      \irBlock{B}
                    & $\mSet{\irBlock{B}}$\\
                      \irBlock{C}
                    & $\mSet{\irBlock{C}}$\\
                      \irBlock{D}
                    & $\mSet{\irBlock{D}}$\\
                      \irBlock{E}
                    & $\mSet{\irBlock{E}}$\\
                    \bottomrule
                  \end{tabular}%
                }%
  \hfill%
  \mbox{}

  \caption{Example of block dominance}
  \labelFigure{block-dominance-example}
\end{figure}%
%
By definition, a \gls{block} always \gls{dominate.b}[s] itself.
%
\todo{finish discussion}



\subsubsection{Variables}

\todo{introduce variables}



\subsubsection{Constraints}

\todo{explain constraints}

\begin{equation}
  \begin{array}{c}
    \mVar{sel}[m] \mImp \mVar{oplace}[o_1] = \mVar{oplace}[o_2] \\
    \forall m \in \mMatchSet,
    \forall o_1 \in \mCovers(m),
    \forall o_2 \in \mCovers(m)
  \end{array}
  \labelEquation{operation-placement}
\end{equation}

\begin{equation}
  \begin{array}{c}
    \mVar{sel}[m] \mImp \mVar{oplace}[o] = b \\
    \forall m \in \mMatchSet,
    \forall o \in \mCovers(m),
    \forall b \in \mEntry(m)
  \end{array}
  \labelEquation{jump-placements}
\end{equation}

\begin{equation}
  \begin{array}{c}
    \mVar{dplace}[d] \in \mDom(\mVar{oplace}[o]) \\
    \forall m \in \mMatchCompSet{\mPhi},
    \forall d \in \mUses(m),
    \forall o \in \mCovers(m)
  \end{array}
  \labelEquation{dom}
\end{equation}

\begin{equation}
  \mVar{dplace}[d] = b
  \mQuantSep
  \forall \mUnDirEdge{d}{b} \in \mDefEdgeSet,
  \labelEquation{def-edges}
\end{equation}

\begin{equation}
  \begin{array}{c}
    \mVar{sel}[m]
    \mImp
    \mVar{dplace}[d] \in \mSet{\mVar{oplace}[o]} \cup \mSpans(m) \\
    \forall m \in \mMatchSet,
    \forall d \in \mDefines(m),
    \forall o \in \mCovers(m)
  \end{array}
  \labelEquation{spanning}
\end{equation}

\begin{equation}
  \begin{array}{c}
    \mVar{sel}[m]
    \mImp
    \mVar{oplace}[o] \neq b \\
    \forall o \in \mOpSet,
    \forall m \in \mMatchSet,
    \forall b \in \mConsumes(m)
  \end{array}
  \labelEquation{consumption}
\end{equation}
