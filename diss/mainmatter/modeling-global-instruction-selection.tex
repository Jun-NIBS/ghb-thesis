% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).

\chapter[Modeling Global Instruction Selection]
        {Modeling Global\\ Instruction Selection}
\labelChapter{modeling-global-instruction-selection}

In \gls{global.is}[ \gls{instruction selection}], a set of \glspl{match} must be
selected such that every \gls{operation} in a given \gls{UF graph} is
\gls{cover}[ed].
%
There are two variants of this problem:
%
\begin{enumerateinline}
  \item each \gls{operation} must appear in \emph{exactly} one selected
    \gls{match}; and
%
  \item each \gls{operation} must appear in \emph{at least} one selected
    \gls{match}, hence allowing matches to \gls{overlap}.
\end{enumerateinline}
%
The former problem is more common as it results in simpler models, with smaller
\glspl{solution space}, and allows use of \glspl{constraint} that enable strong
\gls{propagation}, which are essential for curbing solving time and increasing
scalability.

Depending on the \gls{instruction set}, the latter problem permits
\glspl{solution} with potentially higher code quality.
%
For example, assume a \gls{UF graph} where a sum is used as address in two
memory operations and a \gls{target machine} where the address can be computed
as part of the memory instructions.
%
A \gls{solution} to the latter problem would therefore only need two
instructions, whereas the former problem would require three instructions -- one
to compute the sum and two to perform the memory operations -- since the
addition is not allowed to be covered by both memory instructions.
%
In certain conditions, however, an add instruction may still be required.
%
For example, assume a \gls{UF graph} where the sum is also used in a
subtraction.
%
For this \gls{UF graph}, unless the \gls{target machine} has an instruction that
performs both an addition and a subtraction, a \gls{solution} to either problem
requires an add instruction to compute the sum.

\paragraph{Variables}

TODO: define $\mUFGraph$

For sake of tractability, the constraint model introduced in this chapter
assumes the former problem of \gls{global.is}[ \gls{instruction selection}].
%
The set of \glspl{variable} \mbox{$\mVar{sel}[m] \in \mSet{0, 1}$} models
whether \gls{match}~\mbox{$m \in \mMatchSet$} is selected, where $\mMatchSet$
denotes the match set found for $\mUFGraph$.
%
The set of \glspl{variable} \mbox{$\mVar{omatch}[o] \in \mMatchSet[o]$} models
which selected match covers operation~\mbox{$o \in \mOpSet$}, where $\mOpSet$
denotes the set of operations in $\mUFGraph$, and \mbox{$\mMatchSet[o] \subseteq
  \mMatchSet$} denotes the set of \glspl{match} that can cover~$o$.

\paragraph{Constraints}

\begin{equation}
  \mVar{omatch}[o] = m \mEq \mVar{sel}[m]
  \mQuantSep
  \forall o \in \mOpSet,
  \forall m \in \mMatchSet[o]
  \labelEquation{operation-coverage}
\end{equation}

\begin{equation}
  \mVar{dmatch}[d] = m \mEq \mVar{sel}[m]
  \mQuantSep
  \forall d \in \mDataSet,
  \forall m \in \mMatchSet[d]
  \labelEquation{data-definitions}
\end{equation}



\section{Forbidding Cyclic Data Dependencies}

\paragraph{Constraints}

\begin{equation}
  \sum_{m \in f} \mVar{sel}[m] < \mCard{f}
  \mQuantSep
  \forall f \in \mForbiddenCombSet
  \labelEquation{cyclic-data-deps}
\end{equation}
