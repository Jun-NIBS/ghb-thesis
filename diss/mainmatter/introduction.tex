% Copyright (c) 2017, Gabriel Hjort Blindell <ghb@kth.se>
%
% This work is licensed under a Creative Commons 4.0 International License (see
% LICENSE file or visit <http://creativecommons.org/licenses/by/4.0/> for a copy
% of the license).

\chapter{Introduction}

\todo{write chapter outline}

\section{Overview}

\begin{figure}
  \centering%
  \input{figures/introduction/compiler-overview}

  \caption{Overview of a typical compiler}
  \labelFigure{compiler-overview}
\end{figure}

A \gls!{compiler} is a tool that takes a \gls!{program}, written in some
programming language, as input and produces equivalent assembly code for a
specific \gls!{target machine} as output.
%
As shown in \refFigure{compiler-overview}, a compiler typically consists of
three parts:%
%
\begin{inlinelist}[itemjoin={; }, itemjoin*={; and}]
  \item a \gls!{frontend}, which performs syntactic and semantic analysis and
    transforms the program into an \gls!{IR}
  \item an \gls!{optimizer} (sometimes called \gls!{middle-end}), which performs
    target-independent optimizations
  \item a \gls!{backend}, which performs \gls{code generation}
\end{inlinelist}.

The \gls{optimizer} is arguably the largest component of any \gls{compiler},
consisting of many tasks such as \gls{constant folding}, \gls{dead code
  elimination}, and \gls{loop unrolling}.
%
Another such optimization is \gls!{global code motion}, where operations are
moved from one \gls{basic block} to another, which is done mainly to move
expensive operations into \glspl{block} with lower execution frequency.

The \gls{backend} also consists of several tasks, of which three
typically are most promiment:%
%
\begin{inlinelist}[itemjoin={; }, itemjoin*={; and}]
  \item \gls!{instruction selection}, where \glspl{instruction} implementing the
    given \gls{program} are selected
  \item \gls!{register allocation}, where \gls{virtual.temp} \glspl{temporary}
    are assigned to \glspl{register}
  \item \gls!{instruction scheduling}, where \glspl{instruction} are reordered
    to increase instruction-level parallelism
\end{inlinelist}.
%
Another code generation task of interest is \gls!{block ordering}, where the
\glspl{basic block} are rearranged in order to minimize the number of jump
\glspl{instruction}.

This dissertation focuses primarily on the first \gls{code generation} problem
by introducing a combinatorial optimization model for \gls{instruction
  selection}, which is simpler and more flexible compared to traditional
approaches, and captures more features compared to existing combinatorial
optimization models.
%
The model select \glspl{instruction} globally for entire
\glspl{function} and enables selection of complex \glspl{instruction} not
supported by existing approaches.
%
In addition, it integrates \gls{global code motion} as it is shown that moving
operations across \glspl{basic block} can alleviate \gls{instruction selection}.
%
To this end, the dissertation also introduces a new, graph-based representation
that unifies data flow and control flow for an entire \gls{function} into a
single graph, which enables complex \glspl{instruction} to be modeled as
\glspl{pattern}.
%
Moreover, the representation is crucial for modeling \gls{global.is}
\gls{instruction selection} and \gls{global code motion} as a combinatorial
optimization model.

It is also shown in this disseration that \gls{block ordering} impacts
\gls{instruction selection} (and vice versa).
%
Consequently, the model also integrates \gls{block ordering}, which results in
better code compared to traditional approaches.

Lastly, the dissertation touches upon the other two \gls{code generation}
problems by proposing ideas on how to extend the model to integrate
\gls{instruction scheduling} and \gls{register allocation}.







\section{Motivation}

\begin{filecontents*}{isel-gcmotion-example.c}
int i = 0;
while (i < N) {
  int c = A[i] + B[i];
  if (MAX < c) c = MAX;
  C[i] = c;
  i++;
}
\end{filecontents*}

\begin{figure}
  \centering%
  \subcaptionbox{C code\labelFigure{isel-gcmotion-example-c}}%
                {\lstinputlisting[language=c]{isel-gcmotion-example.c}}%
  \hspace{5mm}%
  \subcaptionbox{Corresponding \gls{IR} and control-flow graph%
                 \labelFigure{example-program-ir}}%
                [64mm]%
                {\input{figures/introduction/isel-gcmotion-example-ir}}%

  \caption[A program computing saturated sums]%
          {%
            A program computing the saturated sums of two arrays, where
            \irVar{A}, \irVar{B}, and \irVar{C} are integer arrays of equal
            lengths stored in memory, and \irVar{N} and \irVar{MAX} are
            constants representing the array length and the upper limit,
            respectively. An integer is assumed to be 4~bytes%
          }
  \labelFigure{isel-gcmotion-example}%
\end{figure}

\paragraph{For global instruction selection}

\RefFigure{isel-gcmotion-example} shows a program that computes the saturated
sums of two integer arrays. In saturation arithmetic, the result of an
arithmetic operation will always stay within a range fixed by a minimum and
maximum value. If the operation would produce a value outside of this range,
then the value is set (``clamped'') to the closest limit, thus becoming
``saturated''.

Assume a \gls{target machine} which has an instruction capable of performing
multiple add operations (a so-called \gls!{SIMD.instr}[ \gls{instruction}]).

\paragraph{For integrating instruction selection and global code motion}

Assume that the \gls{target machine} also has an instruction capable of
performing multiple add operations (a so-called \gls!{SIMD.instr}[
  \gls{instruction}]).

\todo{use previous example}

\paragraph{For integrating instruction selection and block ordering}

\todo{Give another example}

\todo{Traditional approaches (how)}
\todo{Limitations (why)}
\todo{Combinatorial optimization (what)}
\todo{Combinatorial approaches (how)}
\todo{Limitations (why)}
\todo{Research goal (what)}

\section{Thesis Statement}

\begin{statement}
  \Glstext{constraint programming} is a flexible, practical, and competitive
  approach for combining \gls{global.is} \gls{instruction selection},
  \gls{global code motion}, and \gls{block ordering}.
\end{statement}

\todo{Define ``flexible''}
\todo{Define ``practical''}
\todo{Define ``competitive''}

\section{Approach}

\todo{Overview figure}

\section{Contributions}

The dissertation makes six contributions to the areas of code generation and
constraint programming:
%
\begin{contributions}
  \item \labelContribution{survey}
    a comprehensive and structured survey that covers over four decades of
    research in \gls{instruction selection};
  \item \labelContribution{representations}
    a program and instruction representation that enables
    \begin{contributions}
      \item \labelContribution{rep-uniformity}
        uniform treatment of data- and control-flow \glspl{operation}, and
      \item \labelContribution{rep-complex-instructions}
        modeling and pattern matching of complex \glspl{instruction} as
        \glspl{pattern}, and
      \item \labelContribution{rep-combining-problems}
        modeling of \gls{global.is} \gls{instruction selection} and \gls{global
          code motion} as a \gls{constraint model};
    \end{contributions}
  \item \labelContribution{constraint-model}
    a \gls{constraint model} and related transformations that, for the first
    time, integrates
    \begin{contributions}
      \item \labelContribution{cp-global-instruction-selection}
        \gls{global.is} \gls{instruction selection} with
      \item \labelContribution{cp-global-code-motion}
        \gls{global code motion},
    \end{contributions}
    and also integrates
    \begin{contributions}[resume]
      \item \labelContribution{cp-data-copying}
        \gls{data copying},
      \item \labelContribution{cp-block-ordering}
        \gls{block ordering}, and
      \item \labelContribution{cp-value-reuse}
        \gls{value reuse};
    \end{contributions}
  \item \labelContribution{solving-techniques}
    solving techniques that enable practical solving of the \gls{constraint
      model};
  \item \labelContribution{experiments}
    thorough experiments demonstrating that the approach scales to medium-sized
    programs and yields better code than traditional approaches; and
  \item \labelContribution{integration}
    an initial design showing how the \gls{constraint model} can be extended to
    integrate other code generation tasks, such as \gls{instruction scheduling}
    and \gls{register allocation}.
\end{contributions}
%
\refTable{contributions-per-chapter} shows in which chapters each contribution
is manifested and discussed further.

\begin{table}
  \centering%
  \begin{tabular}{c@{\qquad}*{12}{c}}
    \toprule
      \tabhead Chapter
    & \tabhead\refContribution{survey}
    & \multicolumn{3}{c}{\tabhead\refContribution{representations}}
    & \multicolumn{5}{c}{\tabhead\refContribution{constraint-model}}
    & \tabhead\refContribution{solving-techniques}
    & \tabhead\refContribution{experiments}
    & \tabhead\refContribution{integration} \\
    \cmidrule(lr){3-5}%
    \cmidrule(lr){6-10}%
    &
    & \tabhead\refContribution{rep-uniformity}
    & \tabhead\refContribution{rep-complex-instructions}
    & \tabhead\refContribution{rep-combining-problems}
    & \tabhead\refContribution{cp-global-instruction-selection}
    & \tabhead\refContribution{cp-global-code-motion}
    & \tabhead\refContribution{cp-data-copying}
    & \tabhead\refContribution{cp-block-ordering}
    & \tabhead\refContribution{cp-value-reuse}
    &
    &
    & \\
    \midrule
    \refChapter*{current-instruction-selection-techniques}
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{universal-representations}
    & \supportNo
    & \supportYes
    & \supportYes
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{pattern-matching}
    & \supportNo
    & \supportYes
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{modeling-global-instruction-selection}
    & \supportNo
    & \supportYes
    & \supportNo
    & \supportYes
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{modeling-global-code-motion}
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportYes
    & \supportNo
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{modeling-data-copying}
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{modeling-block-ordering}
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{modeling-value-reuse}
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{solving-techniques}
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportYes
    & \supportNo
    & \supportNo \\
    \refChapter*{comparison-against-the-state-of-the-art}
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportYes
    & \supportNo \\
    \refChapter*{integrating-other-code-generation-tasks}
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportYes \\
    \refChapter*{macro-expansion}
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{tree-covering}
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{dag-covering}
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refChapter*{graph-covering}
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \bottomrule
  \end{tabular}

  \caption{Contributions per chapter}
  \labelTable{contributions-per-chapter}
\end{table}

\section{Publications}

This dissertation is based on material presented in the following publications:
%
\begin{publications}
  \item \labelPublication{survey-book}
    \fullcite{HjortBlindell:2016:Survey}.
  \item \labelPublication{cp-paper}
    \fullcite{HjortBlindellEtAl:2015:CP}.
  \item \labelPublication{cases-paper}
    \fullcite{HjortBlindellEtAl:2017:CASES}.
\end{publications}
%
\refTable{contributions-per-publication} shows the relation between the
contributions and the publications above.
%
\begin{table}
  \centering%
  \begin{tabular}{c@{\qquad}*{10}{c}}
    \toprule
      \tabhead Publication
    & \tabhead\refContribution{survey}
    & \tabhead\refContribution{representations}
    & \multicolumn{5}{c}{\tabhead\refContribution{constraint-model}}
    & \tabhead\refContribution{solving-techniques}
    & \tabhead\refContribution{experiments}
    & \tabhead\refContribution{integration} \\
    \cmidrule(lr){4-8}%
    &
    &
    & \tabhead\refContribution{cp-global-instruction-selection}
    & \tabhead\refContribution{cp-global-code-motion}
    & \tabhead\refContribution{cp-data-copying}
    & \tabhead\refContribution{cp-block-ordering}
    & \tabhead\refContribution{cp-value-reuse}
    &
    &
    & \\
    \midrule
    \refPublication{survey-book}
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo \\
    \refPublication{cp-paper}
    & \supportNo
    & \supportYes
    & \supportYes
    & \supportYes
    & \supportYes
    & \supportYes
    & \supportNo
    & \supportNo
    & \supportYes
    & \supportNo \\
    \refPublication{cases-paper}
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportNo
    & \supportYes
    & \supportYes
    & \supportYes
    & \supportNo \\
    \bottomrule
  \end{tabular}

  \caption{Contributions per publication}
  \labelTable{contributions-per-publication}
\end{table}

The author also participated in the following publications, which are out of
scope for the dissertation:

\begin{publications}[resume]
  \item \labelPublication{survey-report}
    \fullcite{HjortBlindell:2013:Survey}.
  \item \labelPublication{lctes}
    \fullcite{CastanedaLozanoEtAl:2014:LCTES}.
  \item \labelPublication{cc}
    \fullcite{CastanedaLozanoEtAl:2016:CC}.
  \item \labelPublication{fdl-2016}
    \fullcite{HjortBlindellEtAl:2016:FDL}.
\end{publications}
%
\refPublication{survey-report} is excluded as it is subsumed and extended by
\refPublication{survey-book}. \refPublication{lctes} and \refPublication{cc} are
excluded as they are only partially related to the dissertation (they apply
\gls{constraint programming} to solve \gls{register allocation} and
\gls{instruction scheduling}). \refPublication{fdl-2016} is excluded as it
belongs to a different topic entirely (high-level code generation for graphics
processors).

\section{Outline}

\todo{Describe chapters}
\todo{Add figure illustrating how to read the dissertation}
